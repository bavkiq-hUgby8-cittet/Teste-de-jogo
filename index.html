<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>Qual é a Palavra? - Rebuild</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Confetti para celebrações -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    body {
      background: linear-gradient(to bottom right, #f0f4f8, #d9e8fc);
    }
    .fade-in {
      animation: fadeIn 0.5s forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
    .fade-out {
      animation: fadeOut 0.5s forwards;
    }
    @keyframes fadeOut {
      to { opacity: 0; }
    }
    .hover-scale:hover {
      transform: scale(1.05);
      transition: transform 0.2s;
    }
  </style>
</head>
<body class="min-h-screen">
<div id="app" class="max-w-4xl mx-auto p-4">

  <!-- Canvas para confetes -->
  <canvas id="confettiCanvas" class="pointer-events-none fixed top-0 left-0 w-screen h-screen z-50"></canvas>

  <!-- TELA DE CONFIGURAÇÃO -->
  <div id="configScreen" class="fade-in bg-white shadow-xl rounded-xl p-4">
    <h1 class="text-2xl font-extrabold mb-4 text-center">Configuração Inicial</h1>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Idioma:</label>
      <div class="flex gap-2">
        <label class="flex items-center gap-1">
          <input type="radio" name="idioma" value="PT-BR" checked />
          <span>PT-BR</span>
        </label>
        <label class="flex items-center gap-1">
          <input type="radio" name="idioma" value="EN-US" />
          <span>EN-US</span>
        </label>
      </div>
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Tempo Máximo (seg.):</label>
      <input
        type="number"
        id="tempoMaximo"
        min="5"
        value="60"
        class="border border-gray-300 p-2 rounded w-full"
      />
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Jogadores (4 ou mais, par):</label>
      <div class="flex gap-2">
        <input
          type="text"
          id="nomeJogador"
          placeholder="Nome"
          class="border border-gray-300 p-2 rounded w-full"
        />
        <button
          id="btnAddJogador"
          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
        >
          Adicionar
        </button>
      </div>
      <div
        id="listaJogadores"
        class="mt-2 p-2 bg-gray-50 border border-gray-200 rounded h-32 overflow-y-auto"
      ></div>
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Modo Duplas:</label>
      <select id="modoDuplas" class="border border-gray-300 p-2 rounded w-full">
        <option value="aleatorio">Aleatório</option>
        <option value="manual">Manual (Sequencial)</option>
      </select>
    </div>

    <button
      id="btnIniciar"
      class="w-full bg-green-500 text-white font-bold py-2 rounded hover:bg-green-600"
    >
      Iniciar
    </button>
  </div>

  <!-- TELA PRINCIPAL -->
  <div id="mainScreen" class="hidden fade-in bg-white shadow-xl rounded-xl p-4">
    <div class="flex justify-between mb-4">
      <button id="btnEncerrar" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">Encerrar</button>
      <div>
        <h2 class="text-lg font-bold">Pontuação</h2>
        <div id="scoreContainer" class="bg-gray-50 p-2 mt-1 rounded border border-gray-200"></div>
      </div>
    </div>

    <div id="painelDupla" class="bg-blue-50 p-3 rounded mb-4">
      <h2 class="font-bold mb-2">Dupla Atual</h2>
      <p><strong>Dica:</strong> <span id="nomeDoador">Jogador Dica</span></p>
      <p><strong>Adivinha:</strong> <span id="nomeAdiv">Jogador Adivinha</span></p>
      <p>
        <strong>Palavra:</strong>
        <span id="palavraSecreta" class="text-red-600 font-semibold">???</span>
      </p>
      <p><strong>Tempo:</strong> <span id="tempoRestante">60</span> seg</p>
      <button id="btnIniciarTimer" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">Iniciar Timer</button>
      <button id="btnPular" class="bg-gray-300 px-2 py-1 rounded hover:bg-gray-400">Pular</button>
    </div>

    <div class="mb-4">
      <label class="block font-bold">Dica para Adivinhador:</label>
      <input type="text" id="campoDica" class="border border-gray-300 p-2 rounded w-full" />
      <button id="btnEnviarDica" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 mt-2">Enviar Dica</button>
    </div>

    <div class="mb-4">
      <label class="block font-bold">Chute do Adivinhador:</label>
      <input type="text" id="campoChute" class="border border-gray-300 p-2 rounded w-full" />
      <button id="btnEnviarChute" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 mt-2">Enviar Chute</button>
    </div>

    <div>
      <h3 class="font-bold">Histórico</h3>
      <div id="historico" class="bg-gray-50 p-2 mt-2 rounded border border-gray-200 h-32 overflow-y-auto"></div>
    </div>
  </div>

  <!-- TELA FINAL -->
  <div id="endScreen" class="hidden fade-in bg-white shadow-xl rounded-xl p-4">
    <h1 class="text-2xl font-bold mb-3">Partida Encerrada</h1>
    <p id="resultado" class="text-xl"></p>
    <div id="finalPontuacao" class="mt-2"></div>
    <button id="btnReiniciar" class="mt-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Reiniciar</button>
  </div>
</div>

<script>
  // ==================
  //  Canvas Confetti
  // ==================
  const confettiCanvas = document.getElementById("confettiCanvas");
  const confettiCtx = confettiCanvas.getContext("2d");
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;

  window.addEventListener("resize", () => {
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  });

  function launchConfetti() {
    const end = Date.now() + 2000; // 2 seconds
    (function frame() {
      confetti({
        particleCount: 5,
        angle: Math.random() * 60 + 100,
        spread: 55,
        origin: { x: Math.random(), y: Math.random() * 0.3 },
        useWorker: true,
      });
      if (Date.now() < end) {
        requestAnimationFrame(frame);
      }
    })();
  }

  // ==================
  //  Dados do Jogo
  // ==================
  let jogadores = [];
  let duplas = [];
  let scores = [];
  let palavrasRodada = [];

  let indicePalavra = 0;
  let duplaAtual = 0;
  let tempoMaximoValue = 60;
  let tempoRestante = 60;
  let timerInterval = null;

  // Declarada APENAS UMA VEZ:
  let primeiraTentativa = true;

  let historicoArr = [];

  // Banco de Palavras
  const palavrasBanco = {
    "PT-BR": ["cachorro", "arco-iris", "vermelho", "futebol", "jantar"],
    "EN-US": ["dog", "rainbow", "red", "soccer", "dinner"],
  };

  // =====================
  //  Referências DOM
  // =====================
  const configScreen = document.getElementById("configScreen");
  const mainScreen = document.getElementById("mainScreen");
  const endScreen = document.getElementById("endScreen");

  const inputTempoMaximo = document.getElementById("tempoMaximo");
  const inputNomeJogador = document.getElementById("nomeJogador");
  const listaJogadores = document.getElementById("listaJogadores");
  const modoDuplas = document.getElementById("modoDuplas");

  const btnAddJogador = document.getElementById("btnAddJogador");
  const btnIniciar = document.getElementById("btnIniciar");
  const btnEncerrar = document.getElementById("btnEncerrar");
  const btnIniciarTimer = document.getElementById("btnIniciarTimer");
  const btnPular = document.getElementById("btnPular");
  const btnEnviarDica = document.getElementById("btnEnviarDica");
  const btnEnviarChute = document.getElementById("btnEnviarChute");
  const btnReiniciar = document.getElementById("btnReiniciar");

  const nomeDoador = document.getElementById("nomeDoador");
  const nomeAdiv = document.getElementById("nomeAdiv");
  const palavraSecreta = document.getElementById("palavraSecreta");
  const tempoRestanteEl = document.getElementById("tempoRestante");

  const historico = document.getElementById("historico");
  const scoreContainer = document.getElementById("scoreContainer");
  const resultadoEl = document.getElementById("resultado");
  const finalPontuacao = document.getElementById("finalPontuacao");

  const campoDica = document.getElementById("campoDica");
  const campoChute = document.getElementById("campoChute");

  // =====================
  //  Eventos
  // =====================
  btnAddJogador.addEventListener("click", () => {
    const nome =
      inputNomeJogador.value.trim() ||
      `Convidado#${jogadores.length + 1}`;
    jogadores.push(nome);
    renderJogadores();
    inputNomeJogador.value = "";
  });

  btnIniciar.addEventListener("click", iniciarJogo);
  btnEncerrar.addEventListener("click", encerrarPartida);

  btnIniciarTimer.addEventListener("click", startTimer);
  btnPular.addEventListener("click", () => {
    registrar("PULOU", "Jogador pulou", duplas[duplaAtual][1]);
    stopTimer();
    proxPalavra();
  });

  btnEnviarDica.addEventListener("click", () => {
    const txt = campoDica.value.trim();
    if (!txt) return;
    registrar("DICA", txt, duplas[duplaAtual][0]);
    campoDica.value = "";
  });

  btnEnviarChute.addEventListener("click", () => {
    const txt = campoChute.value.trim();
    if (!txt) return;
    const word = palavrasRodada[indicePalavra];
    if (!word) return;

    // Se acertou
    if (txt.toLowerCase() === word.toLowerCase()) {
      const pts = primeiraTentativa ? 2 : 1;
      scores[duplaAtual] += pts;
      registrar("ACERTO", `${txt} +${pts}pts`, duplas[duplaAtual][1]);
      renderPontuacao();
      proxPalavra();
    } else {
      // Se errou
      registrar("ERRO", txt, duplas[duplaAtual][1]);
      if (primeiraTentativa) {
        primeiraTentativa = false; // não redeclarar!
      }
      proxDuplaMesmaPalavra();
    }
    campoChute.value = "";
  });

  btnReiniciar.addEventListener("click", reiniciar);

  // ======================
  //  Funções Principais
  // ======================
  function iniciarJogo() {
    // Valida jogadores
    if (jogadores.length < 4 || jogadores.length % 2 !== 0) {
      alert("Precisamos de ao menos 4 jogadores, número par.");
      return;
    }
    duplas = [];
    let arrCopia = [...jogadores];
    if (modoDuplas.value !== "manual") {
      shuffleArray(arrCopia);
    }
    for (let i = 0; i < arrCopia.length; i += 2) {
      duplas.push([arrCopia[i], arrCopia[i + 1]]);
    }
    scores = new Array(duplas.length).fill(0);

    // Define idioma
    const selIdioma = document.querySelector('input[name="idioma"]:checked');
    const chosen = selIdioma ? selIdioma.value : "PT-BR";
    let words = Array.from(new Set(palavrasBanco[chosen] || []));
    shuffleArray(words);
    palavrasRodada = words.slice(0, 5);

    indicePalavra = 0;
    duplaAtual = 0;
    primeiraTentativa = true;

    tempoMaximoValue = parseInt(inputTempoMaximo.value) || 60;
    tempoRestante = tempoMaximoValue;
    tempoRestanteEl.textContent = tempoRestante;

    historicoArr = [];
    renderHistorico();
    renderPontuacao();
    atualizarDupla();

    // Mostrar tela principal
    configScreen.classList.add("hidden");
    mainScreen.classList.remove("hidden");
  }

  function encerrarPartida() {
    stopTimer();
    mainScreen.classList.add("hidden");
    endScreen.classList.remove("hidden");

    // Verifica ganhador(es)
    let maxScore = Math.max(...scores);
    let indicesMax = scores
      .map((val, idx) => (val === maxScore ? idx : -1))
      .filter((i) => i >= 0);

    if (indicesMax.length > 1) {
      resultadoEl.textContent = "Temos um Empate!";
    } else {
      const [p1, p2] = duplas[indicesMax[0]];
      resultadoEl.textContent = `Dupla Vencedora: ${p1} & ${p2}`;
    }

    // Exibe pontuações
    finalPontuacao.innerHTML = "";
    duplas.forEach((dup, i) => {
      const div = document.createElement("div");
      div.className = "my-2";
      div.textContent = `${dup[0]} & ${dup[1]}: ${scores[i]} pts`;
      finalPontuacao.appendChild(div);
    });

    launchConfetti();
  }

  function reiniciar() {
    jogadores = [];
    duplas = [];
    scores = [];
    palavrasRodada = [];
    indicePalavra = 0;
    duplaAtual = 0;
    primeiraTentativa = true;
    historicoArr = [];

    inputNomeJogador.value = "";
    listaJogadores.innerHTML = "";

    stopTimer();

    endScreen.classList.add("hidden");
    configScreen.classList.remove("hidden");
  }

  // ======================
  //  Funções Auxiliares
  // ======================
  function renderJogadores() {
    listaJogadores.innerHTML = "";
    jogadores.forEach((nome, i) => {
      const div = document.createElement("div");
      div.className =
        "bg-gray-50 border border-gray-200 p-2 rounded my-1 flex justify-between items-center";

      const sp = document.createElement("span");
      sp.textContent = nome;
      div.appendChild(sp);

      const btnRem = document.createElement("button");
      btnRem.textContent = "Excluir";
      btnRem.className =
        "bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600";
      btnRem.addEventListener("click", () => {
        jogadores.splice(i, 1);
        renderJogadores();
      });
      div.appendChild(btnRem);

      listaJogadores.appendChild(div);
    });
  }

  function renderPontuacao() {
    scoreContainer.innerHTML = "";
    duplas.forEach((dup, i) => {
      const row = document.createElement("div");
      row.className = "bg-gray-100 p-2 rounded my-1 flex justify-between";
      const sp = document.createElement("span");
      sp.textContent = `${dup[0]} & ${dup[1]}`;
      row.appendChild(sp);
      const points = document.createElement("span");
      points.className = "font-bold";
      points.textContent = scores[i] + " pts";
      row.appendChild(points);
      scoreContainer.appendChild(row);
    });
  }

  function renderHistorico() {
    historico.innerHTML = "";
    historicoArr.forEach((h) => {
      const div = document.createElement("div");
      div.textContent = `[${h.acao}] ${h.jogador} : ${h.msg}`;
      historico.appendChild(div);
    });
    historico.scrollTop = historico.scrollHeight;
  }

  function registrar(acao, msg, jogador) {
    historicoArr.push({ acao, msg, jogador });
    renderHistorico();
  }

  function atualizarDupla() {
    const [d1, d2] = duplas[duplaAtual];
    nomeDoador.textContent = d1;
    nomeAdiv.textContent = d2;
    palavraSecreta.textContent = palavrasRodada[indicePalavra] || "???";
    campoDica.value = "";
    campoChute.value = "";
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  function startTimer() {
    stopTimer();
    tempoRestante = tempoMaximoValue;
    tempoRestanteEl.textContent = tempoRestante;
    timerInterval = setInterval(() => {
      tempoRestante--;
      tempoRestanteEl.textContent = tempoRestante;
      if (tempoRestante <= 0) {
        stopTimer();
        registrar("PULOU", "Tempo Esgotado!", duplas[duplaAtual][1]);
        proxDuplaMesmaPalavra();
      }
    }, 1000);
  }

  function proxPalavra() {
    stopTimer();
    indicePalavra++;
    if (indicePalavra >= palavrasRodada.length) {
      encerrarPartida();
      return;
    }
    duplaAtual = (duplaAtual + 1) % duplas.length;
    primeiraTentativa = true;
    tempoRestante = tempoMaximoValue;
    tempoRestanteEl.textContent = tempoRestante;
    atualizarDupla();
  }

  function proxDuplaMesmaPalavra() {
    stopTimer();
    duplaAtual = (duplaAtual + 1) % duplas.length;
    tempoRestante = tempoMaximoValue;
    tempoRestanteEl.textContent = tempoRestante;
    atualizarDupla();
  }

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  // Exibe a tela inicial
  function showConfig() {
    configScreen.classList.remove("hidden");
    mainScreen.classList.add("hidden");
    endScreen.classList.add("hidden");
  }
  showConfig();
</script>
</body>
</html>