<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Qual √© a Palavra? - Refactor</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Canvas Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    .hover-scale:hover {
      transform: scale(1.2);
      transition: transform 0.2s;
      cursor: pointer;
    }
    .secret-centered {
      font-size: 2rem;
      font-weight: bold;
      color: #ff0000;
    }
    /* Animacao simples para o "acerto" (fotos crescendo e sumindo) */
    @keyframes growAndFade {
      0% {
        transform: scale(0.1);
        opacity: 0;
      }
      20% {
        transform: scale(1);
        opacity: 1;
      }
      80% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% {
        transform: scale(1.4);
        opacity: 0;
      }
    }
  </style>
</head>
<body class="w-screen min-h-screen bg-gradient-to-br from-gray-100 to-blue-100 p-2 md:p-6 overflow-x-hidden">

<div id="app" class="flex flex-col justify-center items-center w-full max-w-[1920px] mx-auto relative">

  <canvas id="confettiCanvas" class="pointer-events-none fixed top-0 left-0 w-full h-full z-50"></canvas>

  <!-- Modal de Regras -->
  <div id="modalRegras" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 items-center justify-center hidden z-40">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg mx-auto">
      <h2 class="text-2xl font-bold mb-4">Regras do Jogo</h2>
      <p class="mb-4">
        1) Voc√™ deve formar duplas de jogadores.<br>
        2) Em cada palavra, a dupla que iniciar tem chance de ganhar 2 pontos se acertar de primeira.<br>
        3) Se errar, as outras duplas ganham 1 ponto se acertarem.<br>
        4) Se pular ou o tempo acabar, passa para a pr√≥xima dupla ou pr√≥xima palavra.<br>
        5) Ao final, a dupla com mais pontos vence.<br>
        <!-- Nova regra -->
        6) N√£o pode usar o radical da pr√≥pria palavra como dica, sob pena de perder a vez.<br>
      </p>
      <button id="btnFalarRegras" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-semibold shadow-lg mb-4 transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-300">
        Falar Regras
      </button>
      <button id="btnFecharModal" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-semibold shadow-lg transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-300">Fechar</button>
    </div>
  </div>

  <!-- Tela de Configura√ß√£o -->
  <div id="config-screen" class="w-full max-w-4xl p-4 md:p-6 shadow-2xl bg-gradient-to-r from-white to-gray-50 rounded-2xl mb-4">
    <!-- CAIXA ATRAS DA FRASE "QUAL √â A PALAVRA?" -->
    <div class="bg-blue-200 p-4 rounded-xl shadow-md">
      <h1 class="text-4xl font-extrabold mb-2 text-center">QUAL √â A PALAVRA?</h1>
    </div>
    <h2 class="text-2xl font-extrabold mb-6 text-center mt-4">Configura√ß√£o Inicial</h2>

    <div class="flex flex-col md:flex-row justify-between mb-4 items-center gap-4">
      <div>
        <label class="block mb-2 font-semibold">Escolha o idioma das palavras:</label>
        <div id="idiomaEscolha" class="flex gap-4 flex-wrap">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="idiomaRadio" value="PT-BR" checked>
            <span class="text-2xl">üáßüá∑</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="idiomaRadio" value="PT-PT">
            <span class="text-2xl">üáµüáπ</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="idiomaRadio" value="EN-US">
            <span class="text-2xl">üá∫üá∏</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="idiomaRadio" value="ES">
            <span class="text-2xl">üá™üá∏</span>
          </label>
        </div>
      </div>
      <button id="btnRegras" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded font-bold shadow-lg transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-purple-300">
        Regras?
      </button>
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Tempo M√°ximo (segundos):</label>
      <select id="tempoMaximo" class="border border-gray-300 p-1 text-sm rounded w-24">
        <option value="30">30 s</option>
        <option value="60" selected>60 s</option>
        <option value="90">90 s</option>
      </select>
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Jogadores:</label>
      <div class="flex gap-2 mb-2 flex-wrap">
        <input type="text" id="nomeJogador" class="border border-gray-300 p-3 rounded w-full md:w-1/2" placeholder="Nome do Jogador">
        <input type="file" id="fotoJogador" accept="image/*" capture="user" class="border border-gray-300 p-3 rounded w-full md:w-1/2 bg-white">
      </div>

      <div class="flex gap-2 mb-4">
        <button id="btnAbrirCamera" class="bg-blue-400 hover:bg-blue-500 text-white px-3 py-2 rounded font-semibold shadow">Abrir C√¢mera</button>
        <button id="btnCapturarFoto" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded font-semibold shadow hidden">Capturar Foto</button>
      </div>

      <div class="relative">
        <video id="videoCamera" class="border border-gray-300 w-64 h-48 object-cover rounded hidden" autoplay muted></video>
        <canvas id="canvasFoto" class="border border-gray-300 w-64 h-48 object-cover rounded hidden"></canvas>
      </div>

      <div class="flex justify-end mb-2">
        <button id="btnAdicionarJogador" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded font-bold shadow-lg transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-300">Adicionar</button>
      </div>

      <div id="listaJogadores" class="bg-blue-50 border border-blue-200 p-3 rounded h-32 overflow-y-auto"></div>
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Forma√ß√£o das Duplas:</label>
      <select id="modoDuplas" class="w-full border border-gray-300 p-3 rounded">
        <option value="aleatorio">Aleat√≥rio</option>
        <option value="manual">Manual (Sequencial)</option>
      </select>
    </div>

    <button id="btnIniciar" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded w-full font-bold text-lg shadow-lg transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-300 hover:scale-105 active:scale-95">Iniciar</button>
  </div>

  <!-- TELA PRINCIPAL -->
  <div id="main-screen" class="w-full md:aspect-[16/9] max-w-[1600px] bg-white rounded-xl shadow-2xl relative hidden">
    <div class="absolute top-0 left-0 w-full p-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button id="btnEncerrar" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-semibold shadow transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-300 hover:scale-105">Encerrar Partida</button>
        <button id="btnPular" class="bg-gray-400 hover:bg-gray-500 text-white px-3 py-2 rounded font-semibold shadow transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-300">Pular</button>
      </div>

      <!-- Tempo Restante mais central e maior -->
      <div class="text-center flex flex-col items-center gap-2">
        <p class="text-xl font-bold">Tempo Restante</p>
        <p id="tempoRestante" class="text-green-600 font-extrabold text-6xl">60</p>
        <div class="flex gap-2">
          <button id="btnIniciarTempo" class="rounded-full w-12 h-12 bg-green-500 hover:bg-green-600 text-white flex items-center justify-center shadow transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-300 hover:scale-105" title="Iniciar Tempo">‚è≤</button>
          <button id="btnResetTempo" class="rounded-full w-12 h-12 bg-orange-500 hover:bg-orange-600 text-white flex items-center justify-center shadow transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-orange-300 hover:scale-105" title="Reiniciar Tempo">üîÑ</button>
        </div>
      </div>

      <div id="boxPontuacao" class="bg-gradient-to-r from-blue-50 to-white p-4 rounded-xl shadow-md text-sm">
        <h2 class="text-lg font-bold mb-2 text-center">Pontua√ß√£o</h2>
        <div id="scoreContainer" class="flex flex-col gap-2"></div>
      </div>
    </div>

    <div class="absolute bottom-0 left-0 w-full p-4">
      <div class="bg-gradient-to-br from-blue-50 to-white rounded-2xl shadow p-4 flex flex-col md:flex-row gap-4">
        <div id="doadorContainer" class="flex-1 bg-blue-100 rounded-xl p-2 flex flex-col gap-2">
          <h2 class="text-xl font-semibold">Jogador 1 (Dica)</h2>
          <div class="flex items-center gap-2">
            <img id="doadorFoto" src="" alt="Foto do Doador" class="w-10 h-10 object-cover rounded-full hidden"/>
            <p class="text-lg font-bold text-blue-700"><span id="doador" class="bg-white rounded px-2 py-1"></span></p>
          </div>
          <label class="block font-bold text-sm">Dica:</label>
          <div class="flex items-center gap-2">
            <input type="text" id="campoDica" class="border border-gray-300 p-2 rounded w-full bg-white" placeholder="D√™ sua dica..."/>
            <button id="btnEnviarDica" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-semibold shadow transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-300">OK</button>
          </div>
        </div>

        <div id="adivinhadorContainer" class="flex-1 bg-blue-100 rounded-xl p-2 flex flex-col gap-2">
          <h2 class="text-xl font-semibold">Jogador 2 (Adivinhador)</h2>
          <div class="flex items-center gap-2">
            <img id="adivinhadorFoto" src="" alt="Foto do Adivinhador" class="w-10 h-10 object-cover rounded-full hidden"/>
            <p class="text-lg font-bold text-green-700"><span id="adivinhador" class="bg-white rounded px-2 py-1"></span></p>
          </div>
          <label class="block font-bold text-sm">Chute:</label>
          <div class="flex items-center gap-2">
            <input type="text" id="campoChute" class="border border-gray-300 p-2 rounded w-full bg-white" placeholder="Qual a palavra?"/>
            <button id="btnEnviarChute" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-semibold shadow transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-300">OK</button>
          </div>
        </div>

        <div class="flex-1 bg-white rounded-xl p-2 shadow flex flex-col gap-2 justify-center items-center">
          <input type="checkbox" id="togglePalavra" class="hidden" />
          <label for="togglePalavra" id="labelToggle" class="cursor-pointer bg-gray-300 p-2 rounded shadow flex items-center">
            <span id="eyeIcon" class="text-6xl">üôà</span>
          </label>
          <span id="palavraSecreta" class="hidden bg-white px-2 py-1 rounded shadow flex flex-col items-center gap-1">
            <span class="text-2xl font-extrabold uppercase text-red-600">Palavra Secreta:</span>
            <span id="conteudoPalavra" class="text-xl font-bold uppercase text-red-500"></span>
          </span>
        </div>
      </div>

      <div class="mt-4 bg-gradient-to-br from-blue-50 to-white p-4 rounded-2xl shadow">
        <h3 class="text-xl font-semibold mb-2">Hist√≥rico</h3>
        <div id="historicoAcoes" class="h-40 overflow-y-auto text-sm border border-gray-300 p-2 rounded bg-white"></div>
      </div>
    </div>

    <div id="secretCenter" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-5xl font-extrabold text-red-600 hidden pointer-events-none">
      <span id="palavraSecretaCentro"></span>
    </div>
  </div>

  <div id="end-screen" class="w-full max-w-4xl p-6 shadow-2xl bg-gradient-to-r from-white to-gray-50 rounded-2xl text-center mt-8 hidden relative">
    <h1 class="text-2xl font-bold mb-4">Partida Encerrada</h1>
    <p id="resultado" class="text-xl mb-2"></p>
    <div id="pontuacaoFinal" class="mb-4"></div>
    <button id="btnReiniciar" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-semibold shadow-lg transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-300 hover:scale-105">Reiniciar</button>
  </div>

</div>

<script>
  /*
    Additional Test Cases:
    1) Expect error if we have 3 players instead of 4.
    2) Expect to start game with no error if we have 4 players.

    Nova feature: banco de 2000 palavras (placeholder); e checagem de radical.
    Se o jogador usar o radical da palavra, exibe "fora da regra do jogo" e passa a vez.

    FIX: Only a single global declaration of timerInterval (no duplication inside iniciarJogo).
  */

  const colorPalette = [
    "bg-red-200 text-red-800",
    "bg-green-200 text-green-800",
    "bg-yellow-200 text-yellow-800",
    "bg-purple-200 text-purple-800",
    "bg-pink-200 text-pink-800",
    "bg-orange-200 text-orange-800",
    "bg-blue-200 text-blue-800",
    "bg-teal-200 text-teal-800"
  ];

  const confettiCanvas = document.getElementById("confettiCanvas");
  const confettiCtx = confettiCanvas.getContext("2d");
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;

  window.addEventListener("resize", () => {
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  });

  function launchConfetti() {
    const end = Date.now() + 2 * 1000;
    (function frame() {
      confetti({
        particleCount: 5,
        angle: Math.random() * 60 + 100,
        spread: 55,
        origin: { x: Math.random(), y: Math.random() * 0.3 },
        useWorker: true
      });
      if (Date.now() < end) {
        requestAnimationFrame(frame);
      }
    })();
  }

  function showAcertoAnimation(duplaIndex){
    const [player1, player2] = duplas[duplaIndex];
    const floatDiv = document.createElement("div");
    floatDiv.className = "absolute top-1/2 left-1/2 flex items-center justify-center gap-4 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-full p-4 shadow-2xl animate-[growAndFade_2s_ease-in-out_forwards]";

    if(player1.photo){
      const img1 = document.createElement("img");
      img1.src = player1.photo;
      img1.alt = "Foto Jogador 1";
      img1.className = "w-20 h-20 object-cover rounded-full";
      floatDiv.appendChild(img1);
    }
    if(player2.photo){
      const img2 = document.createElement("img");
      img2.src = player2.photo;
      img2.alt = "Foto Jogador 2";
      img2.className = "w-20 h-20 object-cover rounded-full";
      floatDiv.appendChild(img2);
    }

    document.body.appendChild(floatDiv);
    setTimeout(()=>{
      if(floatDiv && floatDiv.parentNode){
        floatDiv.parentNode.removeChild(floatDiv);
      }
    },2000);
  }

  function shuffleArray(array){
    for(let i=array.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  // Exemplo de 2000 palavras. (Placeholder real teria 2000 strings.)
  // Aqui apenas exemplificamos.
  const bigWordSet = [];
  for(let i=1; i<=2000; i++){
    bigWordSet.push("palavra"+i);
  }

  const palavrasBanco={
    "PT-BR": bigWordSet, // substitui as 5 antigas por 2000 no PT-BR
    "PT-PT":["c√£o","arc-√≠ris","vermelho","futebol","jantar"],
    "EN-US":["dog","rainbow","red","soccer","dinner"],
    "ES":["perro","arcoiris","rojo","futbol","cena"]
  };

  const modalRegras=document.getElementById("modalRegras");
  const btnRegras=document.getElementById("btnRegras");
  const btnFecharModal=document.getElementById("btnFecharModal");
  const btnFalarRegras=document.getElementById("btnFalarRegras");

  const configScreen=document.getElementById("config-screen");
  const mainScreen=document.getElementById("main-screen");
  const endScreen=document.getElementById("end-screen");

  const inputTempoMaximo=document.getElementById("tempoMaximo");
  const inputNomeJogador=document.getElementById("nomeJogador");
  const inputFotoJogador=document.getElementById("fotoJogador");
  const listaJogadoresEl=document.getElementById("listaJogadores");
  const modoDuplasSelect=document.getElementById("modoDuplas");

  const btnAbrirCamera=document.getElementById("btnAbrirCamera");
  const btnCapturarFoto=document.getElementById("btnCapturarFoto");
  const videoCamera=document.getElementById("videoCamera");
  const canvasFoto=document.getElementById("canvasFoto");
  let cameraStream=null;
  let tempFotoDataUrl="";

  const btnAdicionarJogador=document.getElementById("btnAdicionarJogador");
  const btnIniciar=document.getElementById("btnIniciar");
  const btnEncerrar=document.getElementById("btnEncerrar");
  const btnIniciarTempo=document.getElementById("btnIniciarTempo");
  const btnResetTempo=document.getElementById("btnResetTempo");

  const btnEnviarDica=document.getElementById("btnEnviarDica");
  const btnEnviarChute=document.getElementById("btnEnviarChute");
  const btnPular=document.getElementById("btnPular");
  const btnReiniciar=document.getElementById("btnReiniciar");

  const scoreContainer=document.getElementById("scoreContainer");
  const doadorEl=document.getElementById("doador");
  const doadorFoto=document.getElementById("doadorFoto");
  const adivinhadorEl=document.getElementById("adivinhador");
  const adivinhadorFoto=document.getElementById("adivinhadorFoto");
  const palavraSecretaEl=document.getElementById("palavraSecreta");
  const conteudoPalavraEl=document.getElementById("conteudoPalavra");
  const tempoRestanteEl=document.getElementById("tempoRestante");
  const campoDica=document.getElementById("campoDica");
  const campoChute=document.getElementById("campoChute");
  const historicoAcoes=document.getElementById("historicoAcoes");
  const endResultado=document.getElementById("resultado");
  const endPontuacaoFinal=document.getElementById("pontuacaoFinal");
  const togglePalavraCheckbox=document.getElementById("togglePalavra");
  const eyeIcon=document.getElementById("eyeIcon");

  const secretCenter=document.getElementById("secretCenter");
  const palavraSecretaCentro=document.getElementById("palavraSecretaCentro");

  let jogadores=[];
  let duplas=[];
  let scores=[];
  let palavrasRodada=[];
  let indicePalavra=0;
  let duplaAtual=0;
  let primeiraTentativa=true;
  let mostraPalavra=false;
  let tempoMaximoValue=60;
  let tempoRestante=60;
  // Global single declaration only.
  let timerInterval=null;

  let historico=[];

  function exibirTelaConfig(){
    configScreen.classList.remove("hidden");
    mainScreen.classList.add("hidden");
    endScreen.classList.add("hidden");
  }

  function exibirTelaPrincipal(){
    configScreen.classList.add("hidden");
    mainScreen.classList.remove("hidden");
    endScreen.classList.add("hidden");

    // Ao ir para a tela principal, primeiro mostro a palavra secreta.
    togglePalavraCheckbox.checked = true;
    palavraSecretaEl.classList.remove("hidden");
    eyeIcon.textContent = "üëÅÔ∏è";
  }

  function exibirTelaFinal(){
    configScreen.classList.add("hidden");
    mainScreen.classList.add("hidden");
    endScreen.classList.remove("hidden");
  }

  function getSelectedIdioma(){
    const checked=document.querySelector("input[name=idiomaRadio]:checked");
    return checked?checked.value:"PT-BR";
  }

  function falarRegras(){
    const msg=new SpeechSynthesisUtterance();
    msg.text=`1) Voc√™ deve formar duplas de jogadores.\n2) Em cada palavra, a dupla que iniciar tem chance de ganhar 2 pontos se acertar de primeira.\n3) Se errar, as outras duplas ganham 1 ponto se acertarem.\n4) Se pular ou o tempo acabar, passa para a pr√≥xima dupla ou palavra.\n5) Ao final, a dupla com mais pontos vence.\n6) N√£o pode usar o radical da pr√≥pria palavra como dica.`;
    msg.lang="pt-BR";
    speechSynthesis.speak(msg);
  }

  btnRegras.addEventListener("click",()=>{
    modalRegras.classList.remove("hidden");
    modalRegras.classList.add("flex");
  });

  btnFecharModal.addEventListener("click",()=>{
    modalRegras.classList.add("hidden");
    modalRegras.classList.remove("flex");
  });

  btnFalarRegras.addEventListener("click",falarRegras);

  btnAbrirCamera.addEventListener("click",async()=>{
    try{
      cameraStream=await navigator.mediaDevices.getUserMedia({video:true});
      videoCamera.srcObject=cameraStream;
      videoCamera.classList.remove("hidden");
      btnCapturarFoto.classList.remove("hidden");
      canvasFoto.classList.add("hidden");
    }catch(err){
      alert("N√£o foi poss√≠vel acessar a c√¢mera: "+err);
    }
  });

  btnCapturarFoto.addEventListener("click",()=>{
    if(!cameraStream)return;
    canvasFoto.classList.remove("hidden");
    canvasFoto.width=videoCamera.videoWidth;
    canvasFoto.height=videoCamera.videoHeight;
    const ctx=canvasFoto.getContext("2d");
    ctx.drawImage(videoCamera,0,0,canvasFoto.width,canvasFoto.height);
    let dataUrl=canvasFoto.toDataURL("image/png");

    videoCamera.classList.add("hidden");
    btnCapturarFoto.classList.add("hidden");
    if(cameraStream){
      cameraStream.getTracks().forEach(track=>track.stop());
      cameraStream=null;
    }
    tempFotoDataUrl=dataUrl;
  });

  btnAdicionarJogador.addEventListener("click",adicionarJogador);

  function adicionarJogador(){
    if(jogadores.length >= 10){
      alert("N√∫mero m√°ximo de 10 jogadores atingido!");
      return;
    }

    let nomeDigitado=inputNomeJogador.value.trim()||`Convidado #${jogadores.length+1}`;
    let colorClass=colorPalette[jogadores.length%colorPalette.length];
    let fotoDataUrl="";

    const file=inputFotoJogador.files[0];
    if(tempFotoDataUrl){
      fotoDataUrl=tempFotoDataUrl;
      tempFotoDataUrl="";
    }else if(file){
      const reader=new FileReader();
      reader.onload=(e)=>{
        fotoDataUrl=e.target.result;
        pushJogador(nomeDigitado,colorClass,fotoDataUrl);
      };
      reader.readAsDataURL(file);
      return;
    }

    pushJogador(nomeDigitado,colorClass,fotoDataUrl);
  }

  function pushJogador(name,colorClass,photo){
    const newPlayer={name,color:colorClass,photo};
    jogadores.push(newPlayer);
    inputNomeJogador.value="";
    fotoJogador.value="";
    renderJogadores();
  }

  function removerJogador(idx){
    jogadores.splice(idx,1);
    renderJogadores();
  }

  function renderJogadores(){
    listaJogadoresEl.innerHTML="";
    jogadores.forEach((player,idx)=>{
      const div=document.createElement("div");
      div.className=`${player.color} p-2 uppercase rounded mb-1 shadow-sm font-bold flex items-center gap-2 justify-between`;
      const leftPart=document.createElement("div");
      leftPart.className="flex items-center gap-2";

      if(player.photo){
        const imgEl=document.createElement("img");
        imgEl.src=player.photo;
        imgEl.alt="Foto";
        imgEl.className="w-8 h-8 object-cover rounded-full";
        leftPart.appendChild(imgEl);
      }

      const spanNome=document.createElement("span");
      spanNome.textContent=player.name;
      leftPart.appendChild(spanNome);
      div.appendChild(leftPart);

      const btnRem=document.createElement("button");
      btnRem.textContent="X";
      btnRem.className="bg-red-400 hover:bg-red-500 text-white px-2 py-1 rounded font-bold";
      btnRem.addEventListener("click",()=>{
        removerJogador(idx);
      });
      div.appendChild(btnRem);

      listaJogadoresEl.appendChild(div);
    });
  }

  function resetTempo(){
    tempoRestante=tempoMaximoValue;
    tempoRestanteEl.textContent=tempoRestante;
  }

  function iniciarJogo(){
    if(jogadores.length<4 || jogadores.length%2!==0){
      alert("√â necess√°rio ao menos 4 jogadores (n√∫mero par)." );
      return;
    }
    if(jogadores.length>10){
      alert("M√°ximo de 10 jogadores!");
      return;
    }

    duplas=[];
    const modo=modoDuplasSelect.value;
    let arrCopia=[...jogadores];
    if(modo!=="manual"){
      shuffleArray(arrCopia);
    }

    for(let i=0;i<arrCopia.length;i+=2){
      duplas.push([arrCopia[i],arrCopia[i+1]]);
    }

    scores=new Array(duplas.length).fill(0);

    const idioma=getSelectedIdioma();
    let listaPalavrasBrutas=Array.from(new Set(palavrasBanco[idioma]||[]));
    shuffleArray(listaPalavrasBrutas);
    palavrasRodada=listaPalavrasBrutas.slice(0,5);

    indicePalavra=0;
    duplaAtual=0;
    primeiraTentativa=true;
    tempoMaximoValue=parseInt(inputTempoMaximo.value)||60;
    tempoRestante=tempoMaximoValue;
    tempoRestanteEl.textContent=tempoRestante;
    tempoRestanteEl.classList.remove("text-red-600");
    tempoRestanteEl.classList.add("text-green-600");
    mostraPalavra=false;
    togglePalavraCheckbox.checked=false;
    palavraSecretaEl.classList.add("hidden");
    eyeIcon.textContent="üôà";
    historico=[];
    atualizarHistoricoNaTela();
    renderPontuacao();
    atualizarDuplaNaTela();
    exibirTelaPrincipal();

    document.getElementById("doadorContainer").classList.remove("bg-blue-100");
    document.getElementById("doadorContainer").classList.add("bg-blue-300");
    document.getElementById("adivinhadorContainer").classList.remove("bg-blue-300");
    document.getElementById("adivinhadorContainer").classList.add("bg-blue-100");
  }

  btnIniciar.addEventListener("click",iniciarJogo);

  function atualizarDuplaNaTela(){
    const doadorPlayer=duplas[duplaAtual][0];
    const adivPlayer=duplas[duplaAtual][1];
    doadorEl.textContent=doadorPlayer.name.toUpperCase();
    adivinhadorEl.textContent=adivPlayer.name.toUpperCase();
    conteudoPalavraEl.textContent=palavrasRodada[indicePalavra]||"";

    if(doadorPlayer.photo){
      doadorFoto.src=doadorPlayer.photo;
      doadorFoto.classList.remove("hidden");
    }else{
      doadorFoto.classList.add("hidden");
    }
    if(adivPlayer.photo){
      adivinhadorFoto.src=adivPlayer.photo;
      adivinhadorFoto.classList.remove("hidden");
    }else{
      adivinhadorFoto.classList.add("hidden");
    }
  }

  function pararTimer(){
    if(timerInterval){
      clearInterval(timerInterval);
      timerInterval=null;
    }
  }

  function iniciarTimer(){
    pararTimer();
    timerInterval=setInterval(()=>{
      tempoRestante--;
      tempoRestanteEl.textContent=tempoRestante;
      if(tempoRestante<=10){
        tempoRestanteEl.classList.remove("text-green-600");
        tempoRestanteEl.classList.add("text-red-600");
      }else{
        tempoRestanteEl.classList.remove("text-red-600");
        tempoRestanteEl.classList.add("text-green-600");
      }
      if(tempoRestante<=0){
        pararTimer();
        registrarHistorico("PULOU","Tempo Esgotado.",getAdivinhadorName());
        passarParaProximaDuplaMesmaPalavra();
      }
    },1000);
  }

  btnIniciarTempo.addEventListener("click",iniciarTimer);
  btnResetTempo.addEventListener("click",()=>{
    resetTempo();
  });

  function encerrarPartida(){
    exibirTelaFinal();
    pararTimer();
    let maiorPontuacao=Math.max(...scores);
    let indicesMax=scores.map((val,idx)=>(val===maiorPontuacao?idx:-1)).filter(i=>i>=0);
    if(indicesMax.length>1){
      endResultado.textContent="Temos um empate!";
    }else{
      const campeaoArr=duplas[indicesMax[0]];
      const campeao=campeaoArr[0].name+" & "+campeaoArr[1].name;
      endResultado.textContent="Dupla Vencedora: "+campeao;
    }
    endPontuacaoFinal.innerHTML="<h2 class='font-semibold'>Pontua√ß√£o Final</h2>";
    duplas.forEach((dupla,idx)=>{
      let nomes=dupla[0].name.toUpperCase()+" & "+dupla[1].name.toUpperCase();
      const div=document.createElement("div");
      div.className="flex items-center gap-2 my-2";
      dupla.forEach((p)=>{
        if(p.photo){
          const img=document.createElement("img");
          img.src=p.photo;
          img.alt="Foto";
          img.className="w-8 h-8 object-cover rounded-full";
          div.appendChild(img);
        }
      });
      const txt=document.createElement("span");
      txt.textContent=nomes+": "+scores[idx]+" pts";
      div.appendChild(txt);
      endPontuacaoFinal.appendChild(div);
    });
    indicesMax.forEach(()=>{
      launchConfetti();
    });
  }

  btnEncerrar.addEventListener("click",encerrarPartida);

  function reiniciar(){
    jogadores=[];
    duplas=[];
    scores=[];
    palavrasRodada=[];
    indicePalavra=0;
    duplaAtual=0;
    mostraPalavra=false;
    tempoRestante=60;
    historico=[];
    inputNomeJogador.value="";
    fotoJogador.value="";
    renderJogadores();
    exibirTelaConfig();
  }

  btnReiniciar.addEventListener("click",reiniciar);

  function violaRegraRadical(texto, palavraSecreta){
    const radical = palavraSecreta.toLowerCase().substring(0,4);
    return texto.toLowerCase().includes(radical);
  }

  function enviarDica(){
    const dica=campoDica.value.trim();
    if(!dica)return;

    const currentWord = palavrasRodada[indicePalavra];
    if(violaRegraRadical(dica, currentWord)){
      alert("Fora da regra do jogo: dica cont√©m radical da pr√≥pria palavra!");
      registrarHistorico("ERRO","(Dica violou regra!)", getDoadorName());
      passarParaProximaDuplaMesmaPalavra();
      campoDica.value="";
      return;
    }

    registrarHistorico("DICA",dica,getDoadorName());
    campoDica.value="";

    resetTempo();

    document.getElementById("doadorContainer").classList.remove("bg-blue-300");
    document.getElementById("doadorContainer").classList.add("bg-blue-100");
    document.getElementById("adivinhadorContainer").classList.remove("bg-blue-100");
    document.getElementById("adivinhadorContainer").classList.add("bg-blue-300");
  }

  btnEnviarDica.addEventListener("click",enviarDica);

  function enviarChute(){
    const chute=campoChute.value.trim();
    if(!chute)return;
    const palavraAtual=palavrasRodada[indicePalavra];
    if(!palavraAtual)return;

    if(violaRegraRadical(chute, palavraAtual)){
      alert("Fora da regra do jogo: chute cont√©m radical da pr√≥pria palavra!");
      registrarHistorico("ERRO","(Chute violou regra!)", getAdivinhadorName());
      passarParaProximaDuplaMesmaPalavra();
      campoChute.value="";
      return;
    }

    resetTempo();

    if(chute.toLowerCase()===palavraAtual.toLowerCase()){
      const adiv=getAdivinhadorName();
      const pontos=primeiraTentativa?2:1;
      registrarHistorico("ACERTO",chute,adiv,pontos);
      scores[duplaAtual]+=pontos;
      renderPontuacao();
      showAcertoAnimation(duplaAtual);
      launchConfetti();
      passarParaProximaPalavra();
    }else{
      registrarHistorico("ERRO",chute,getAdivinhadorName());
      if(primeiraTentativa) primeiraTentativa=false;
      passarParaProximaDuplaMesmaPalavra();
    }
    campoChute.value="";

    document.getElementById("doadorContainer").classList.remove("bg-blue-100");
    document.getElementById("doadorContainer").classList.add("bg-blue-300");
    document.getElementById("adivinhadorContainer").classList.remove("bg-blue-300");
    document.getElementById("adivinhadorContainer").classList.add("bg-blue-100");
  }

  btnEnviarChute.addEventListener("click",enviarChute);

  function pularPalavra(){
    registrarHistorico("PULOU","Palavra pulada",getAdivinhadorName());
    pararTimer();
    passarParaProximaPalavra();
  }

  btnPular.addEventListener("click",pularPalavra);

  function passarParaProximaPalavra(){
    indicePalavra++;
    if(indicePalavra>=palavrasRodada.length){
      encerrarPartida();
      return;
    }
    duplaAtual=(duplaAtual+1)%duplas.length;
    tempoRestante=tempoMaximoValue;
    tempoRestanteEl.textContent=tempoRestante;
    primeiraTentativa=true;
    tempoRestanteEl.classList.remove("text-red-600");
    tempoRestanteEl.classList.add("text-green-600");
    mostraPalavra=false;
    togglePalavraCheckbox.checked=false;
    palavraSecretaEl.classList.add("hidden");
    eyeIcon.textContent="üôà";
    atualizarDuplaNaTela();

    document.getElementById("doadorContainer").classList.remove("bg-blue-100");
    document.getElementById("doadorContainer").classList.add("bg-blue-300");
    document.getElementById("adivinhadorContainer").classList.remove("bg-blue-300");
    document.getElementById("adivinhadorContainer").classList.add("bg-blue-100");
  }

  function passarParaProximaDuplaMesmaPalavra(){
    pararTimer();
    duplaAtual=(duplaAtual+1)%duplas.length;
    tempoRestante=tempoMaximoValue;
    tempoRestanteEl.textContent=tempoRestante;
    tempoRestanteEl.classList.remove("text-red-600");
    tempoRestanteEl.classList.add("text-green-600");
    mostraPalavra=false;
    togglePalavraCheckbox.checked=false;
    palavraSecretaEl.classList.add("hidden");
    eyeIcon.textContent="üôà";
    atualizarDuplaNaTela();

    document.getElementById("doadorContainer").classList.remove("bg-blue-100");
    document.getElementById("doadorContainer").classList.add("bg-blue-300");
    document.getElementById("adivinhadorContainer").classList.remove("bg-blue-300");
    document.getElementById("adivinhadorContainer").classList.add("bg-blue-100");
  }

  function renderPontuacao(){
    scoreContainer.innerHTML="";
    duplas.forEach((dupla,idx)=>{
      let nomes=dupla[0].name.toUpperCase()+" & "+dupla[1].name.toUpperCase();
      const row=document.createElement("div");
      row.className="p-2 bg-white rounded shadow flex items-center gap-2";
      dupla.forEach((p)=>{
        if(p.photo){
          const img=document.createElement("img");
          img.src=p.photo;
          img.alt="Foto";
          img.className="w-6 h-6 object-cover rounded-full";
          row.appendChild(img);
        }
      });
      const txt=document.createElement("span");
      txt.className="font-bold text-sm";
      txt.textContent=nomes;
      row.appendChild(txt);
      const pts=document.createElement("span");
      pts.className="text-blue-700 font-extrabold text-lg ml-auto";
      pts.textContent=scores[idx]+" pts";
      row.appendChild(pts);
      scoreContainer.appendChild(row);
    });
  }

  function registrarHistorico(acao,texto,jogador,pontos){
    const currentWord=palavrasRodada[indicePalavra]||"";
    historico.push({acao,texto,jogador,points:pontos,palavra:currentWord});
    atualizarHistoricoNaTela();
  }

  function atualizarHistoricoNaTela(){
    historicoAcoes.innerHTML="";
    historico.forEach((h)=>{
      let mensagem="";
      let icone="";
      if(h.acao==="DICA"){icone="üí°";mensagem=`${icone} ${h.jogador}: "${h.texto}"`;}
      else if(h.acao==="ERRO"){icone="‚ùå";mensagem=`${icone} ${h.jogador}: "${h.texto}"`;}
      else if(h.acao==="ACERTO"){icone="‚úÖ";mensagem=`${icone} ${h.jogador} +${h.points||0} pts`;}
      else if(h.acao==="PULOU"){icone="‚è≠Ô∏è";mensagem=`${icone} ${h.jogador}: ${h.texto}`;}
      const secretIcon=document.createElement("span");
      secretIcon.textContent="üëÅÔ∏è";
      secretIcon.className="ml-2 text-blue-700 hover-scale";
      secretIcon.title="Ver palavra secreta";
      secretIcon.addEventListener("click",()=>{
        alert(`A palavra secreta era: ${h.palavra}`);
      });
      const div=document.createElement("div");
      div.textContent=mensagem;
      div.appendChild(secretIcon);
      historicoAcoes.appendChild(div);
    });
    historicoAcoes.scrollTop=historicoAcoes.scrollHeight;
  }

  function getDoadorName(){
    return duplas[duplaAtual][0].name.toUpperCase();
  }
  function getAdivinhadorName(){
    return duplas[duplaAtual][1].name.toUpperCase();
  }

  exibirTelaConfig();
</script>

</body>
</html>
