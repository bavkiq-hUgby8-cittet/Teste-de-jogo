<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Qual é a Palavra? - Updated Requests</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    .hover-scale:hover {
      transform: scale(1.2);
      transition: transform 0.2s;
      cursor: pointer;
    }
    .secret-centered {
      font-size: 2rem;
      font-weight: bold;
      color: #ff0000;
    }

    /* For celebratory animation (photos growing) */
    @keyframes growAndFade {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      80% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% {
        transform: scale(1.3);
        opacity: 0;
      }
    }

    /* Estilos para o destaque do jogador da vez */
    .active-turn {
      border: 4px solid #3b82f6; /* azul tailwind (blue-500) */
    }
  </style>
</head>
<body
  class="w-screen min-h-screen bg-gradient-to-br from-gray-100 to-blue-100 p-2 md:p-6 overflow-x-hidden"
>
  <div
    id="app"
    class="flex flex-col justify-center items-center w-full max-w-[1920px] mx-auto relative"
  >
    <canvas
      id="confettiCanvas"
      class="pointer-events-none fixed top-0 left-0 w-full h-full z-50"
    ></canvas>

    <!-- Modal de Regras -->
    <div
      id="modalRegras"
      class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 items-center justify-center hidden z-40"
    >
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg mx-auto">
        <h2 class="text-2xl font-bold mb-4">Regras do Jogo</h2>
        <p class="mb-4">
          1) Você deve formar duplas de jogadores.<br />
          2) Em cada palavra, a dupla que iniciar tem chance de ganhar 2 pontos
          se acertar de primeira.<br />
          3) Se errar, as outras duplas (ou a mesma dupla em nova vez) ganham 1
          ponto se acertarem.<br />
          4) Se pular ou o tempo acabar, passa para a próxima dupla ou próxima
          palavra.<br />
          5) Ao final, a dupla com mais pontos vence.<br />
        </p>
        <button
          id="btnFalarRegras"
          class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-semibold shadow-lg mb-4
                 transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-300"
        >
          Falar Regras
        </button>
        <button
          id="btnFecharModal"
          class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-semibold shadow-lg
                 transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-300"
        >
          Fechar
        </button>
      </div>
    </div>

    <!-- Tela de Configuração -->
    <div
      id="config-screen"
      class="w-full max-w-4xl p-4 md:p-6 shadow-2xl bg-gradient-to-r from-white to-gray-50 rounded-2xl mb-4"
    >
      <!-- Título principal com box -->
      <div class="bg-blue-200 p-4 rounded shadow-md text-center mb-6">
        <h1 class="text-4xl font-extrabold">QUAL É A PALAVRA?</h1>
      </div>

      <h2 class="text-2xl font-extrabold mb-6 text-center">
        Configuração Inicial
      </h2>

      <!-- Idioma + Botão Regras -->
      <div
        class="flex flex-col md:flex-row justify-between mb-4 items-center gap-4"
      >
        <div>
          <label class="block mb-2 font-semibold"
            >Escolha o idioma das palavras:</label>
          <div id="idiomaEscolha" class="flex gap-4 flex-wrap">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="idiomaRadio" value="PT-BR" checked />
              <span class="text-2xl">🇧🇷</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="idiomaRadio" value="PT-PT" />
              <span class="text-2xl">🇵🇹</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="idiomaRadio" value="EN-US" />
              <span class="text-2xl">🇺🇸</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="idiomaRadio" value="ES" />
              <span class="text-2xl">🇪🇸</span>
            </label>
          </div>
        </div>
        <button
          id="btnRegras"
          class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded font-bold shadow-lg
                 transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-purple-300"
        >
          Regras?
        </button>
      </div>

      <!-- Tempo Máximo (com 120s e padrão 90s) -->
      <div class="mb-4">
        <label class="block mb-1 font-semibold">Tempo Máximo (segundos):</label>
        <select
          id="tempoMaximo"
          class="border border-gray-300 p-1 text-sm rounded w-24"
        >
          <option value="30">30 s</option>
          <option value="60">60 s</option>
          <option value="90" selected>90 s</option>
          <option value="120">120 s</option>
        </select>
      </div>

      <!-- Jogadores (max 10) -->
      <div class="mb-4">
        <label class="block mb-1 font-semibold">Jogadores (máx 10):</label>
        <div class="flex gap-2 mb-2 flex-wrap">
          <input
            type="text"
            id="nomeJogador"
            class="border border-gray-300 p-3 rounded w-full md:w-1/2"
            placeholder="Nome do Jogador"
          />
          <input
            type="file"
            id="fotoJogador"
            accept="image/*"
            capture="user"
            class="border border-gray-300 p-3 rounded w-full md:w-1/2 bg-white"
          />
        </div>

        <div class="flex gap-2 mb-4">
          <button
            id="btnAbrirCamera"
            class="bg-blue-400 hover:bg-blue-500 text-white px-3 py-2 rounded font-semibold shadow"
          >
            Abrir Câmera
          </button>
          <button
            id="btnCapturarFoto"
            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded font-semibold shadow hidden"
          >
            Capturar Foto
          </button>
        </div>

        <!-- Câmera / Canvas -->
        <div class="relative">
          <video
            id="videoCamera"
            class="border border-gray-300 w-64 h-48 object-cover rounded hidden"
            autoplay
            muted
          ></video>
          <canvas
            id="canvasFoto"
            class="border border-gray-300 w-64 h-48 object-cover rounded hidden"
          ></canvas>
        </div>

        <div class="flex justify-end mb-2">
          <button
            id="btnAdicionarJogador"
            class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded font-bold shadow-lg
                   transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-300"
          >
            Adicionar
          </button>
        </div>

        <!-- AUMENTAR A CAIXA que lista jogadores -->
        <div
          id="listaJogadores"
          class="bg-blue-50 border border-blue-200 p-3 rounded h-64 overflow-y-auto"
        ></div>
      </div>

      <!-- Modo de Duplas com 2 botões (Aleatório e Sequencial) -->
      <div class="mb-4">
        <label class="block mb-1 font-semibold">Formação das Duplas:</label>
        <div class="flex gap-2">
          <button
            id="btnModoAleatorio"
            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded font-semibold"
            data-modo="aleatorio"
          >
            Aleatório
          </button>
          <button
            id="btnModoSequencial"
            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded font-semibold"
            data-modo="manual"
          >
            Sequencial
          </button>
        </div>
      </div>

      <button
        id="btnIniciar"
        class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded w-full font-bold text-lg shadow-lg
               transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-300
               hover:scale-105 active:scale-95"
      >
        Iniciar
      </button>
    </div>

    <!-- TELA PRINCIPAL -->
    <div
      id="main-screen"
      class="w-full max-w-[1600px] aspect-video bg-white rounded-xl shadow-2xl relative hidden"
    >
      <!-- TOPO: Encerrar/Pular, Timer, Pontuação -->
      <div
        class="absolute top-0 left-0 w-full p-4 flex items-center justify-between"
      >
        <!-- Esquerda: Encerrar + Pular -->
        <div class="flex items-center gap-2">
          <button
            id="btnEncerrar"
            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-semibold shadow
                   transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-300
                   hover:scale-105"
          >
            Encerrar Partida
          </button>
          <button
            id="btnPular"
            class="bg-gray-400 hover:bg-gray-500 text-white px-3 py-2 rounded font-semibold shadow
                   transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-300"
          >
            Pular
          </button>
        </div>

        <!-- Centro: Timer -->
        <div class="text-center flex flex-col items-center gap-2">
          <p class="text-2xl font-bold">Tempo Restante</p>
          <p
            id="tempoRestante"
            class="text-green-600 font-extrabold text-5xl"
          >
            60
          </p>
          <button
            id="btnIniciarTempo"
            class="rounded-full w-12 h-12 bg-green-500 hover:bg-green-600 text-white flex items-center justify-center shadow
                   transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-300 hover:scale-105"
            title="Iniciar Tempo"
          >
            ⏲
          </button>
        </div>

        <!-- Direita: Pontuação -->
        <div
          id="boxPontuacao"
          class="bg-gradient-to-r from-blue-50 to-white p-4 rounded-xl shadow-md text-sm"
        >
          <h2 class="text-lg font-bold mb-2 text-center">Pontuação</h2>
          <div id="scoreContainer" class="flex flex-col gap-2"></div>
        </div>
      </div>

      <!-- RODAPÉ: 3 CAIXAS ("Dica", Palavra Secreta, Adivinhador) -->
      <div class="absolute bottom-0 left-0 w-full p-4">
        <div class="flex flex-col md:flex-row gap-4 justify-center items-start">
          <!-- Box 1: (Doador) => renomeado para "Dica" + Dica -->
          <div id="boxDoador" class="flex flex-col p-4 bg-gradient-to-br from-blue-50 to-white rounded-2xl shadow w-full md:w-1/3">
            <h2 class="text-xl font-semibold mb-2">Dica</h2>
            <!-- Foto + Nome -->
            <div class="flex items-center gap-2 mb-2">
              <img
                id="doadorFoto"
                src=""
                alt="Foto do Doador"
                class="w-20 h-20 object-cover rounded-full hidden"  <!-- Aumentado tamanho da imagem -->
              />
              <p class="text-lg font-bold text-blue-700">
                <span id="doador" class="bg-white rounded px-2 py-1"></span>
              </p>
            </div>

            <!-- Campo Dica -->
            <label class="block font-bold mb-1">Dica:</label>
            <div class="flex gap-2 mb-2">
              <input
                type="text"
                id="campoDica"
                class="border border-gray-300 p-2 rounded w-full bg-white"
              />
              <button
                id="btnEnviarDica"
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-semibold shadow
                       transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-300"
              >
                OK
              </button>
            </div>
          </div>

          <!-- Box 2: Palavra Secreta -->
          <div id="boxPalavra" class="p-4 bg-gradient-to-br from-blue-50 to-white rounded-2xl shadow w-full md:w-1/3 flex flex-col items-center justify-center gap-2">
            <h2 class="text-xl font-semibold mb-2">Palavra Secreta</h2>

            <input type="checkbox" id="togglePalavra" class="hidden" />
            <label
              for="togglePalavra"
              id="labelToggle"
              class="cursor-pointer bg-gray-300 p-2 rounded shadow flex items-center"
            >
              <!-- Large icon -->
              <span id="eyeIcon" class="text-6xl">🙈</span>
            </label>
            <span
              id="palavraSecreta"
              class="hidden bg-white px-2 py-1 rounded shadow flex items-center gap-2"
            >
              <span class="text-2xl font-extrabold uppercase text-red-600">
                Palavra:
              </span>
              <span
                id="conteudoPalavra"
                class="text-xl font-bold uppercase text-red-500"
              ></span>
            </span>
          </div>

          <!-- Box 3: Adivinhador + Chute -->
          <div id="boxAdiv" class="flex flex-col p-4 bg-gradient-to-br from-blue-50 to-white rounded-2xl shadow w-full md:w-1/3">
            <h2 class="text-xl font-semibold mb-2">Adivinhador</h2>
            <!-- Foto + Nome -->
            <div class="flex items-center gap-2 mb-2">
              <img
                id="adivinhadorFoto"
                src=""
                alt="Foto do Adivinhador"
                class="w-20 h-20 object-cover rounded-full hidden"  <!-- Aumentado tamanho -->
              />
              <p class="text-lg font-bold text-green-700">
                <span id="adivinhador" class="bg-white rounded px-2 py-1"></span>
              </p>
            </div>

            <!-- Campo Chute -->
            <label class="block font-bold mb-1">Chute:</label>
            <div class="flex gap-2 mb-2">
              <input
                type="text"
                id="campoChute"
                class="border border-gray-300 p-2 rounded w-full bg-white"
              />
              <button
                id="btnEnviarChute"
                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-semibold shadow
                       transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-300"
              >
                OK
              </button>
            </div>
          </div>
        </div>

        <!-- Histórico -->
        <div
          class="mt-4 bg-gradient-to-br from-blue-50 to-white p-4 rounded-2xl shadow"
        >
          <h3 class="text-xl font-semibold mb-2">Histórico</h3>
          <div
            id="historicoAcoes"
            class="h-40 overflow-y-auto text-sm border border-gray-300 p-2 rounded bg-white"
          ></div>
        </div>
      </div>

      <!-- Palavra Secreta ao Centro (oculta) -->
      <div
        id="secretCenter"
        class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-5xl font-extrabold text-red-600 hidden pointer-events-none"
      >
        <span id="palavraSecretaCentro"></span>
      </div>
    </div>

    <!-- Tela Final -->
    <div
      id="end-screen"
      class="w-full max-w-4xl p-6 shadow-2xl bg-gradient-to-r from-white to-gray-50 rounded-2xl text-center mt-8 hidden relative"
    >
      <h1 class="text-2xl font-bold mb-4">Partida Encerrada</h1>
      <p id="resultado" class="text-xl mb-2"></p>
      <div id="pontuacaoFinal" class="mb-4"></div>
      <button
        id="btnReiniciar"
        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-semibold shadow-lg
               transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-300
               hover:scale-105"
      >
        Reiniciar
      </button>
    </div>
  </div>

  <script>
  (function () {
    function exibirTelaConfig(){
      configScreen.classList.remove("hidden");
      mainScreen.classList.add("hidden");
      endScreen.classList.add("hidden");
    }
    function exibirTelaPrincipal() {
      configScreen.classList.add("hidden");
      mainScreen.classList.remove("hidden");
      endScreen.classList.add("hidden");
    }
    function exibirTelaFinal() {
      configScreen.classList.add("hidden");
      mainScreen.classList.add("hidden");
      endScreen.classList.remove("hidden");
    }

    // define getSelectedIdioma
    function getSelectedIdioma() {
      const idiomaRadio = document.querySelector('input[name="idiomaRadio"]:checked');
      return idiomaRadio ? idiomaRadio.value : 'PT-BR';
    }

    // Add the existing code:

    let primeiraTentativa = true;
    let jogadores = [];
    let duplas = [];
    let scores = [];
    let palavrasRodada = [];
    let indicePalavra = 0;
    let duplaAtual = 0;
    let mostraPalavra = false;
    let tempoMaximoValue = 90; // default to 90
    let tempoRestante = 90;
    let timerInterval = null;
    let historico = [];
    let cameraStream = null;
    let tempFotoDataUrl = "";

    let modoDuplas = "aleatorio"; // control via 2 buttons

    // GIGANTIC array de 2000 palavras (PT-BR), placeholders
    const bigPTBR = Array.from({length:2000}, (_,i)=>`palavra${i+1}`);

    const palavrasBanco = {
      "PT-PT": ["cão", "arc-íris", "vermelho", "futebol", "jantar"],
      "EN-US": ["dog", "rainbow", "red", "soccer", "dinner"],
      "ES": ["perro", "arcoiris", "rojo", "futbol", "cena"]
    };

    const colorPalette = [
      "bg-red-200 text-red-800",
      "bg-green-200 text-green-800",
      "bg-yellow-200 text-yellow-800",
      "bg-purple-200 text-purple-800",
      "bg-pink-200 text-pink-800",
      "bg-orange-200 text-orange-800",
      "bg-blue-200 text-blue-800",
      "bg-teal-200 text-teal-800"
    ];

    const confettiCanvas = document.getElementById("confettiCanvas");
    const confettiCtx = confettiCanvas.getContext("2d");
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;

    window.addEventListener("resize", () => {
      confettiCanvas.width = window.innerWidth;
      confettiCanvas.height = window.innerHeight;
    });

    function launchConfetti() {
      const end = Date.now() + 2 * 1000;
      (function frame() {
        confetti({
          particleCount: 5,
          angle: Math.random() * 60 + 100,
          spread: 55,
          origin: { x: Math.random(), y: Math.random() * 0.3 },
          useWorker: true
        });
        if (Date.now() < end) {
          requestAnimationFrame(frame);
        }
      })();
    }

    function celebrarAcerto(duplaIndex) {
      const overlay = document.createElement("div");
      overlay.className = "fixed inset-0 flex items-center justify-center z-50 pointer-events-none";

      const duoContainer = document.createElement("div");
      duoContainer.className = "flex items-center gap-4";

      const [p1, p2] = duplas[duplaIndex];
      [p1, p2].forEach((pl) => {
        const imgEl = document.createElement("img");
        imgEl.src = pl.photo || "";
        imgEl.alt = "Foto";
        imgEl.className = "w-16 h-16 object-cover rounded-full animate-zoomPhoto";
        imgEl.style.animation = "growAndFade 2s forwards";
        if (!pl.photo) {
          imgEl.src = "https://via.placeholder.com/64";
        }
        duoContainer.appendChild(imgEl);
      });

      overlay.appendChild(duoContainer);
      document.body.appendChild(overlay);

      setTimeout(() => {
        document.body.removeChild(overlay);
      }, 2000);
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function falarRegras() {
      const msg = new SpeechSynthesisUtterance();
      msg.text = `\n1) Você deve formar duplas de jogadores.\n2) Em cada palavra, a dupla que iniciar tem chance de ganhar 2 pontos se acertar de primeira.\n3) Se errar, as outras duplas (ou a mesma dupla em nova vez) ganham 1 ponto se acertarem.\n4) Se pular ou o tempo acabar, passa para a próxima dupla ou próxima palavra.\n5) Ao final, a dupla com mais pontos vence.\n`;
      msg.lang = "pt-BR";
      speechSynthesis.speak(msg);
    }

    const modalRegras = document.getElementById("modalRegras");
    const btnRegras = document.getElementById("btnRegras");
    const btnFecharModal = document.getElementById("btnFecharModal");
    const btnFalarRegras = document.getElementById("btnFalarRegras");

    const btnModoAleatorio = document.getElementById("btnModoAleatorio");
    const btnModoSequencial = document.getElementById("btnModoSequencial");

    const configScreen = document.getElementById("config-screen");
    const mainScreen = document.getElementById("main-screen");
    const endScreen = document.getElementById("end-screen");

    const inputTempoMaximo = document.getElementById("tempoMaximo");
    const inputNomeJogador = document.getElementById("nomeJogador");
    const inputFotoJogador = document.getElementById("fotoJogador");
    const listaJogadoresEl = document.getElementById("listaJogadores");

    const btnAbrirCamera = document.getElementById("btnAbrirCamera");
    const btnCapturarFoto = document.getElementById("btnCapturarFoto");
    const videoCamera = document.getElementById("videoCamera");
    const canvasFoto = document.getElementById("canvasFoto");

    const btnAdicionarJogador = document.getElementById("btnAdicionarJogador");
    const btnIniciar = document.getElementById("btnIniciar");
    const btnEncerrar = document.getElementById("btnEncerrar");
    const btnIniciarTempo = document.getElementById("btnIniciarTempo");
    const btnEnviarDica = document.getElementById("btnEnviarDica");
    const btnEnviarChute = document.getElementById("btnEnviarChute");
    const btnPular = document.getElementById("btnPular");
    const btnReiniciar = document.getElementById("btnReiniciar");

    const scoreContainer = document.getElementById("scoreContainer");
    const doadorEl = document.getElementById("doador");
    const doadorFoto = document.getElementById("doadorFoto");
    const adivinhadorEl = document.getElementById("adivinhador");
    const adivinhadorFoto = document.getElementById("adivinhadorFoto");
    const palavraSecretaEl = document.getElementById("palavraSecreta");
    const conteudoPalavraEl = document.getElementById("conteudoPalavra");
    const tempoRestanteEl = document.getElementById("tempoRestante");
    const campoDica = document.getElementById("campoDica");
    const campoChute = document.getElementById("campoChute");
    const historicoAcoes = document.getElementById("historicoAcoes");
    const endResultado = document.getElementById("resultado");
    const endPontuacaoFinal = document.getElementById("pontuacaoFinal");
    const togglePalavraCheckbox = document.getElementById("togglePalavra");
    const eyeIcon = document.getElementById("eyeIcon");

    const secretCenter = document.getElementById("secretCenter");
    const palavraSecretaCentro = document.getElementById("palavraSecretaCentro");

    const boxDoador = document.getElementById("boxDoador");
    const boxAdiv = document.getElementById("boxAdiv");

    // Show/hide modal
    btnRegras.addEventListener("click", () => {
      modalRegras.classList.remove("hidden");
      modalRegras.classList.add("flex");
    });
    btnFecharModal.addEventListener("click", () => {
      modalRegras.classList.add("hidden");
      modalRegras.classList.remove("flex");
    });
    btnFalarRegras.addEventListener("click", falarRegras);

    // Switch Modo Duplas by 2 Buttons
    btnModoAleatorio.addEventListener("click", (evt)=>{
      modoDuplas = evt.target.dataset.modo; // "aleatorio"
      btnModoAleatorio.classList.add("bg-blue-300");
      btnModoSequencial.classList.remove("bg-blue-300");
    });
    btnModoSequencial.addEventListener("click", (evt)=>{
      modoDuplas = evt.target.dataset.modo; // "manual"
      btnModoAleatorio.classList.remove("bg-blue-300");
      btnModoSequencial.classList.add("bg-blue-300");
    });

    // Câmera
    btnAbrirCamera.addEventListener("click", async () => {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoCamera.srcObject = cameraStream;
        videoCamera.classList.remove("hidden");
        btnCapturarFoto.classList.remove("hidden");
        canvasFoto.classList.add("hidden");
      } catch (err) {
        alert("Não foi possível acessar a câmera: " + err);
      }
    });

    btnCapturarFoto.addEventListener("click", () => {
      if (!cameraStream) return;
      canvasFoto.classList.remove("hidden");
      canvasFoto.width = videoCamera.videoWidth;
      canvasFoto.height = videoCamera.videoHeight;
      const ctx = canvasFoto.getContext("2d");
      ctx.drawImage(videoCamera, 0, 0, canvasFoto.width, canvasFoto.height);
      let dataUrl = canvasFoto.toDataURL("image/png");

      videoCamera.classList.add("hidden");
      btnCapturarFoto.classList.add("hidden");
      if (cameraStream) {
        cameraStream.getTracks().forEach((track) => track.stop());
        cameraStream = null;
      }
      tempFotoDataUrl = dataUrl;
    });

    btnAdicionarJogador.addEventListener("click", adicionarJogador);

    function adicionarJogador() {
      if (jogadores.length >= 10) {
        alert("Máximo de 10 jogadores atingido!");
        return;
      }
      let nomeDigitado = inputNomeJogador.value.trim() || `Convidado #${jogadores.length + 1}`;
      let colorClass = colorPalette[jogadores.length % colorPalette.length];

      let fotoDataUrl = "";
      const file = inputFotoJogador.files[0];

      if (tempFotoDataUrl) {
        fotoDataUrl = tempFotoDataUrl;
        tempFotoDataUrl = "";
      } else if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          fotoDataUrl = e.target.result;
          pushJogador(nomeDigitado, colorClass, fotoDataUrl);
        };
        reader.readAsDataURL(file);
        return;
      }

      pushJogador(nomeDigitado, colorClass, fotoDataUrl);
    }

    function pushJogador(name, colorClass, fotoDataUrl) {
      const newPlayer = { name, color: colorClass, photo: fotoDataUrl};
      jogadores.push(newPlayer);
      inputNomeJogador.value = "";
      fotoJogador.value = "";
      renderJogadores();
    }

    function removerJogador(idx) {
      jogadores.splice(idx, 1);
      renderJogadores();
    }

    function renderJogadores() {
      listaJogadoresEl.innerHTML = "";
      jogadores.forEach((player, idx) => {
        const div = document.createElement("div");
        div.className = `${player.color} p-2 uppercase rounded mb-1 shadow-sm font-bold flex items-center gap-2 justify-between`;

        const leftPart = document.createElement("div");
        leftPart.className = "flex items-center gap-2";

        if (player.photo) {
          const imgEl = document.createElement("img");
          imgEl.src = player.photo;
          imgEl.alt = "Foto";
          imgEl.className = "w-8 h-8 object-cover rounded-full";
          leftPart.appendChild(imgEl);
        }
        const spanNome = document.createElement("span");
        spanNome.textContent = player.name;
        leftPart.appendChild(spanNome);
        div.appendChild(leftPart);

        const btnRem = document.createElement("button");
        btnRem.textContent = "X";
        btnRem.className = "bg-red-400 hover:bg-red-500 text-white px-2 py-1 rounded font-bold";
        btnRem.addEventListener("click", () => removerJogador(idx));
        div.appendChild(btnRem);

        listaJogadoresEl.appendChild(div);
      });
    }

    togglePalavraCheckbox.addEventListener("change", (evt) => {
      if (evt.target.checked) {
        palavraSecretaEl.classList.remove("hidden");
        eyeIcon.textContent = "👁️";
        mostraPalavra = true;
      } else {
        palavraSecretaEl.classList.add("hidden");
        eyeIcon.textContent = "🙈";
        mostraPalavra = false;
      }
    });

    btnIniciar.addEventListener("click", iniciarJogo);

    function iniciarJogo(){
      if (jogadores.length <4 || (jogadores.length %2 !== 0)) {
        alert('É necessário ao menos 4 jogadores (número par).');
        return;
      }
      duplas = [];
      tempoMaximoValue = parseInt(inputTempoMaximo.value) || 90;
      tempoRestante = tempoMaximoValue;

      let arrCopia = [...jogadores];
      if (modoDuplas === 'aleatorio') {
        shuffleArray(arrCopia);
      }

      for (let i=0; i< arrCopia.length; i+=2){
        duplas.push( [ arrCopia[i], arrCopia[i+1] ] );
      }

      scores = new Array(duplas.length).fill(0);

      let idioma = getSelectedIdioma();
      let listaPalavrasBrutas;
      if (idioma === 'PT-BR'){
        listaPalavrasBrutas = bigPTBR;
      } else {
        listaPalavrasBrutas = Array.from(new Set(palavrasBanco[idioma] || []));
      }
      shuffleArray(listaPalavrasBrutas);
      palavrasRodada = listaPalavrasBrutas.slice(0,5);

      indicePalavra = 0;
      duplaAtual = 0;
      primeiraTentativa = true;

      tempoRestanteEl.textContent = tempoRestante;
      tempoRestanteEl.classList.remove('text-red-600');
      tempoRestanteEl.classList.add('text-green-600');

      mostraPalavra = false;
      togglePalavraCheckbox.checked = false;
      palavraSecretaEl.classList.add('hidden');
      eyeIcon.textContent = '🙈';

      historico = [];
      atualizarHistoricoNaTela();
      renderPontuacao();
      atualizarDuplaNaTela();
      exibirTelaPrincipal();
    }

    function atualizarDuplaNaTela(){
      const doadorPlayer = duplas[duplaAtual][0];
      const adivPlayer = duplas[duplaAtual][1];

      doadorEl.textContent = doadorPlayer.name.toUpperCase();
      adivinhadorEl.textContent = adivPlayer.name.toUpperCase();
      conteudoPalavraEl.textContent = palavrasRodada[indicePalavra] || '';

      boxDoador.classList.remove('active-turn');
      boxAdiv.classList.remove('active-turn');
      boxDoador.classList.add('active-turn');

      if(doadorPlayer.photo){
        doadorFoto.src = doadorPlayer.photo;
        doadorFoto.classList.remove('hidden');
      } else {
        doadorFoto.classList.add('hidden');
      }

      if(adivPlayer.photo){
        adivinhadorFoto.src = adivPlayer.photo;
        adivinhadorFoto.classList.remove('hidden');
      } else {
        adivinhadorFoto.classList.add('hidden');
      }
    }

    function pararTimer(){
      if(timerInterval){
        clearInterval(timerInterval);
        timerInterval=null;
      }
    }

    btnIniciarTempo.addEventListener('click', iniciarTimer);
    function iniciarTimer(){
      pararTimer();
      timerInterval = setInterval(()=>{
        tempoRestante--;
        tempoRestanteEl.textContent = tempoRestante;

        if (tempoRestante <= 10){
          tempoRestanteEl.classList.remove('text-green-600');
          tempoRestanteEl.classList.add('text-red-600');
        } else {
          tempoRestanteEl.classList.remove('text-red-600');
          tempoRestanteEl.classList.add('text-green-600');
        }

        if(tempoRestante <=0){
          pararTimer();
          registrarHistorico("PULOU","Tempo esgotado.",getAdivinhadorName());
          passarParaProximaDuplaMesmaPalavra();
        }
      },1000);
    }

    btnEncerrar.addEventListener('click', encerrarPartida);
    function encerrarPartida(){
      exibirTelaFinal();
      pararTimer();

      let maiorPontuacao = Math.max(...scores);
      let indicesMax = scores.map((val, idx)=>(val===maiorPontuacao? idx : -1)).filter((i)=> i>=0);
      if(indicesMax.length>1){
        endResultado.textContent = 'Temos um Empate!';
      } else {
        const campeaoArr = duplas[indicesMax[0]];
        const campeao = campeaoArr[0].name + ' & ' + campeaoArr[1].name;
        endResultado.textContent = 'Dupla Vencedora: '+ campeao;
      }

      endPontuacaoFinal.innerHTML = "<h2 class='font-semibold'>Pontuação Final</h2>";
      duplas.forEach((dupla,idx)=>{
        let nomes = dupla[0].name.toUpperCase() + ' & ' + dupla[1].name.toUpperCase();
        const div = document.createElement('div');
        div.className='flex items-center gap-2 my-2';
        dupla.forEach((p)=>{
          if(p.photo){
            const img = document.createElement('img');
            img.src = p.photo;
            img.alt = 'Foto';
            img.className='w-8 h-8 object-cover rounded-full';
            div.appendChild(img);
          }
        });
        const txt = document.createElement('span');
        txt.textContent = nomes + ': ' + scores[idx] + ' pts';
        div.appendChild(txt);
        endPontuacaoFinal.appendChild(div);
      });

      indicesMax.forEach(()=>{
        launchConfetti();
      });
    }

    btnReiniciar.addEventListener('click', reiniciar);
    function reiniciar(){
      jogadores=[];
      duplas=[];
      scores=[];
      palavrasRodada=[];
      indicePalavra=0;
      duplaAtual=0;
      mostraPalavra=false;
      tempoRestante=90;
      historico=[];
      inputNomeJogador.value='';
      fotoJogador.value='';
      renderJogadores();
      exibirTelaConfig();
    }

    function renderPontuacao(){
      scoreContainer.innerHTML='';
      duplas.forEach((dupla,idx)=>{
        let nomes = dupla[0].name.toUpperCase() + ' & ' + dupla[1].name.toUpperCase();
        const row = document.createElement('div');
        row.className='p-2 bg-white rounded shadow flex items-center gap-2';
        dupla.forEach((p)=>{
          if(p.photo){
            const img = document.createElement('img');
            img.src = p.photo;
            img.alt='Foto';
            img.className='w-6 h-6 object-cover rounded-full';
            row.appendChild(img);
          }
        });
        const txt = document.createElement('span');
        txt.className='font-bold text-sm';
        txt.textContent = nomes;
        row.appendChild(txt);
        const pts = document.createElement('span');
        pts.className='text-blue-700 font-extrabold text-lg ml-auto';
        pts.textContent=`${scores[idx]} pts`;
        row.appendChild(pts);
        scoreContainer.appendChild(row);
      });
    }

    function registrarHistorico(acao, texto, jogador, pontos){
      const currentWord = palavrasRodada[indicePalavra] || '';
      historico.push({acao, texto, jogador, points:pontos, palavra:currentWord});
      atualizarHistoricoNaTela();
    }

    function atualizarHistoricoNaTela(){
      historicoAcoes.innerHTML='';
      historico.forEach((h)=>{
        let mensagem='';
        let icone='';
        if(h.acao==='DICA'){
          icone='💡';
          mensagem = `${icone} ${h.jogador}: "${h.texto}"`;
        } else if(h.acao==='ERRO'){
          icone='❌';
          mensagem = `${icone} ${h.jogador}: "${h.texto}"`;
        } else if(h.acao==='ACERTO'){
          icone='✅';
          mensagem = `${icone} ${h.jogador} +${h.points||0} pts`;
        } else if(h.acao==='PULOU'){
          icone='⏭️';
          mensagem = `${icone} ${h.jogador}: ${h.texto}`;
        }

        const secretIcon = document.createElement('span');
        secretIcon.textContent='👁️';
        secretIcon.className='ml-2 text-blue-700 hover-scale';
        secretIcon.title='Ver palavra secreta';
        secretIcon.addEventListener('click', ()=>{
          alert(`A palavra secreta era: ${h.palavra}`);
        });
        const div = document.createElement('div');
        div.textContent=mensagem;
        div.appendChild(secretIcon);
        historicoAcoes.appendChild(div);
      });
      historicoAcoes.scrollTop=historicoAcoes.scrollHeight;
    }

    function getDoadorName(){
      return duplas[duplaAtual][0].name.toUpperCase();
    }
    function getAdivinhadorName(){
      return duplas[duplaAtual][1].name.toUpperCase();
    }

    btnEnviarDica.addEventListener('click', enviarDica);
    function enviarDica(){
      const dica = campoDica.value.trim();
      if(!dica)return;
      registrarHistorico('DICA', dica, getDoadorName());
      campoDica.value='';
      boxDoador.classList.remove('active-turn');
      boxAdiv.classList.add('active-turn');
    }

    btnEnviarChute.addEventListener('click', enviarChute);
    function enviarChute(){
      const chute = campoChute.value.trim();
      if(!chute)return;
      const palavraAtual= palavrasRodada[indicePalavra];
      if(!palavraAtual)return;

      if(chute.toLowerCase()=== palavraAtual.toLowerCase()){
        // ACERTO
        const adiv = getAdivinhadorName();
        const pontos = primeiraTentativa? 2:1;
        registrarHistorico('ACERTO',chute, adiv, pontos);
        scores[duplaAtual]+=pontos;
        renderPontuacao();
        launchConfetti();
        celebrarAcerto(duplaAtual);
        passarParaProximaPalavra();
        boxAdiv.classList.remove('active-turn');
        boxDoador.classList.add('active-turn');
      } else {
        // ERRO
        registrarHistorico('ERRO', chute, getAdivinhadorName());
        if(primeiraTentativa){
          primeiraTentativa=false;
        }
        passarParaProximaDuplaMesmaPalavra();
      }
      campoChute.value='';
    }

    btnPular.addEventListener('click', pularPalavra);
    function pularPalavra(){
      registrarHistorico('PULOU','Palavra pulada', getAdivinhadorName());
      pararTimer();
      passarParaProximaPalavra();
      boxAdiv.classList.remove('active-turn');
      boxDoador.classList.add('active-turn');
    }

    function passarParaProximaPalavra(){
      indicePalavra++;
      if(indicePalavra>=palavrasRodada.length){
        encerrarPartida();
        return;
      }
      duplaAtual = (duplaAtual+1)%duplas.length;
      tempoRestante = tempoMaximoValue;
      tempoRestanteEl.textContent=tempoRestante;
      tempoRestanteEl.classList.remove('text-red-600');
      tempoRestanteEl.classList.add('text-green-600');
      primeiraTentativa=true;

      mostraPalavra=false;
      togglePalavraCheckbox.checked=false;
      palavraSecretaEl.classList.add('hidden');
      eyeIcon.textContent='🙈';

      atualizarDuplaNaTela();
    }

    function passarParaProximaDuplaMesmaPalavra(){
      pararTimer();
      duplaAtual = (duplaAtual+1)%duplas.length;
      tempoRestante=tempoMaximoValue;
      tempoRestanteEl.textContent=tempoRestante;
      tempoRestanteEl.classList.remove('text-red-600');
      tempoRestanteEl.classList.add('text-green-600');

      mostraPalavra=false;
      togglePalavraCheckbox.checked=false;
      palavraSecretaEl.classList.add('hidden');
      eyeIcon.textContent='🙈';

      atualizarDuplaNaTela();
    }

    // Start with config screen
    exibirTelaConfig();
  })();
  </script>
</body>
</html>
