<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Qual é a Palavra? - Câmera e Confetes!</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* Fixed to ensure no duplicate let duplas.
       We have only a single global let duplas.
    */

    .hover-scale:hover {
      transform: scale(1.2);
      transition: transform 0.2s;
      cursor: pointer;
    }

    /* LED style for the announcements */
    .led-text {
      font-family: monospace;
      letter-spacing: 2px;
      background: black;
      color: lime;
      padding: 4px 8px;
      border-radius: 4px;
      box-shadow: 0 0 5px rgba(0,255,0,0.5);
    }

    /* Timer bigger than 'Iniciar' => let's push timer container bigger. */
    #tempoContainer {
      transform: scale(1.2);
    }

    /* Button pass icon => we can embed a small icon. */
    #btnPular {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Eye icon etc. same as before. */
    #eyeIcon svg {
      width: 32px;
      height: 32px;
      fill: currentColor;
    }

    .spin {
      animation: spin 1s linear infinite;
      transform-origin: center center;
    }
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .fade-out {
      animation: fadeOut 1s forwards;
    }
    @keyframes fadeOut {
      to {
        opacity: 0;
        pointer-events: none;
      }
    }
    .fade-in {
      animation: fadeIn 1s forwards;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    #duplaAtualPanel {
      background: linear-gradient(to right, #f0f9ff, #e0f2fe);
      border: 2px solid #93c5fd;
      padding: 1rem;
      border-radius: 1rem;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      transition: background 0.5s;
    }
    #duplaAtualPanel:hover {
      background: linear-gradient(to right, #cffafe, #e0f2fe);
    }
  </style>
</head>
<body class="w-screen min-h-screen bg-gradient-to-br from-gray-100 to-blue-100 p-2 md:p-6 overflow-x-hidden">
<div id="app" class="flex flex-col justify-center items-center w-full max-w-[1920px] mx-auto relative">
  <canvas id="confettiCanvas" class="pointer-events-none fixed top-0 left-0 w-full h-full z-50"></canvas>

  <!-- MODAL REGRAS -->
  <div id="modalRegras" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 items-center justify-center hidden z-40">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg mx-auto">
      <h2 class="text-2xl font-bold mb-4">Regras do Jogo</h2>
      <p class="mb-4">
        1) Forme duplas de jogadores, com no mínimo 4 pessoas (número par).<br/>
        2) A cada palavra, a dupla da vez inicia tentando acertar: se acertar de primeira, ganha 2 pontos.<br/>
        3) Se errar, as outras duplas (ou ela mesma, em nova vez) só ganham 1 ponto se acertarem.<br/>
        4) Se pular ou o tempo acabar, passa para a próxima dupla, podendo manter a mesma palavra ou avançar, dependendo do caso.<br/>
        5) Ao final do banco de palavras, a dupla com maior pontuação vence.<br/>
      </p>
      <button id="btnFalarRegras" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-semibold shadow-lg mb-4">
        Falar Regras em Voz Alta
      </button>
      <button id="btnFecharModal" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-semibold shadow-lg">Fechar</button>
    </div>
  </div>

  <!-- TELA CONFIG -->
  <div id="config-screen" class="w-full max-w-4xl p-4 md:p-6 shadow-2xl bg-gradient-to-r from-white to-gray-50 rounded-2xl mb-4">
    <h1 class="text-3xl font-extrabold mb-6 text-center">Configuração Inicial</h1>

    <div class="flex flex-col md:flex-row justify-between mb-4 items-center gap-4">
      <div>
        <label class="block mb-2 font-semibold">Escolha o idioma:</label>
        <div id="idiomaEscolha" class="flex gap-4 flex-wrap">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="idiomaRadio" value="PT-BR" checked>
            <span class="text-2xl">🇧🇷</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="idiomaRadio" value="PT-PT">
            <span class="text-2xl">🇵🇹</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="idiomaRadio" value="EN-US">
            <span class="text-2xl">🇺🇸</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="idiomaRadio" value="ES">
            <span class="text-2xl">🇪🇸</span>
          </label>
        </div>
      </div>
      <button id="btnRegras" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded font-bold shadow-lg">
        Regras?
      </button>
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Tempo Máximo (segundos):</label>
      <input type="number" id="tempoMaximo" min="5" value="60" class="w-full border border-gray-300 p-3 rounded" />
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Jogadores:</label>
      <div class="flex gap-2 mb-2 flex-wrap">
        <input type="text" id="nomeJogador" class="border border-gray-300 p-3 rounded w-full md:w-1/2" placeholder="Nome do Jogador"/>
        <input type="file" id="fotoJogador" accept="image/*" capture="environment" class="border border-gray-300 p-3 rounded w-full md:w-1/2 bg-white"/>
      </div>
      <div class="flex gap-2 mb-4">
        <button id="btnAbrirCamera" class="bg-blue-400 hover:bg-blue-500 text-white px-3 py-2 rounded font-semibold shadow">Abrir Câmera</button>
        <button id="btnCapturarFoto" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded font-semibold shadow hidden">Capturar Foto</button>
      </div>
      <div class="relative">
        <video id="videoCamera" class="border border-gray-300 w-64 h-48 object-cover rounded hidden" autoplay muted></video>
        <canvas id="canvasFoto" class="border border-gray-300 w-64 h-48 object-cover rounded hidden"></canvas>
      </div>
      <div class="flex justify-end mt-2">
        <button id="btnAdicionarJogador" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded font-bold shadow-lg">Adicionar</button>
      </div>
      <div id="listaJogadores" class="bg-blue-50 border border-blue-200 p-3 rounded h-32 overflow-y-auto mt-2">
        <!-- Jogadores -->
      </div>
    </div>

    <div class="mb-4">
      <label class="block mb-1 font-semibold">Formação das Duplas:</label>
      <select id="modoDuplas" class="w-full border border-gray-300 p-3 rounded">
        <option value="aleatorio">Aleatório</option>
        <option value="manual">Manual (Sequencial)</option>
      </select>
    </div>

    <button id="btnIniciar" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded w-full font-bold text-lg shadow-lg">
      Iniciar
    </button>
  </div>

  <!-- MAIN -->
  <div id="main-screen" class="w-full max-w-5xl p-2 md:p-4 hidden">
    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
      <button id="btnEncerrar" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded font-semibold shadow">Encerrar Partida</button>
      <div id="boxPontuacao" class="bg-gradient-to-r from-blue-50 to-white p-4 rounded-xl shadow-md text-sm w-full md:w-96">
        <h2 class="text-lg font-bold mb-3 text-center">Pontuação</h2>
        <div id="scoreContainer" class="flex flex-col gap-2">
          <!-- Scores -->
        </div>
      </div>
    </div>

    <!-- Dupla Atual -->
    <div id="duplaAtualPanel" class="mb-4">
      <div class="mb-3 flex flex-col gap-1 items-center">
        <!-- LED style -->
        <span id="doadorLed" class="led-text"></span>
        <span id="adivLed" class="led-text"></span>
      </div>
      <div class="flex items-center gap-2 mb-2">
        <img id="doadorFoto" src="" alt="Foto do Doador" class="w-12 h-12 object-cover rounded-full hidden"/>
        <p class="text-lg font-bold text-blue-700">JOGADOR DE DICA: <span id="doador" class="bg-white rounded px-2 py-1"></span></p>
      </div>
      <div class="flex items-center gap-2 mb-2">
        <img id="adivinhadorFoto" src="" alt="Foto do Adivinhador" class="w-12 h-12 object-cover rounded-full hidden"/>
        <p class="text-lg font-bold text-green-700">ADIVINHADOR: <span id="adivinhador" class="bg-white rounded px-2 py-1"></span></p>
      </div>
      <div class="mt-2 flex items-center gap-2">
        <input type="checkbox" id="togglePalavra" class="hidden" />
        <label for="togglePalavra" id="labelToggle" class="cursor-pointer bg-gray-300 p-2 rounded shadow flex items-center justify-center">
          <span id="eyeIcon" class="text-gray-800">
            <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
              <path d="M2 32c6-14 18-22 30-22s24 8 30 22c-6 14-18 22-30 22S8 46 2 32z" fill="#ccc"/>
              <path d="M10 10 L54 54" stroke="#444" stroke-width="5"/>
            </svg>
          </span>
        </label>
        <span id="palavraSecreta" class="ml-2 hidden bg-white text-red-500 px-2 py-1 rounded shadow">
          <strong>Palavra Secreta:</strong> <span id="conteudoPalavra"></span>
        </span>
      </div>
    </div>

    <!-- Timer e Pular -->
    <div class="mb-4 flex flex-col items-center justify-center gap-4" id="tempoContainer">
      <div class="text-2xl font-bold flex gap-2 items-center">
        <span>Tempo Restante:</span>
        <span id="tempoRestante" class="text-green-600 font-extrabold text-3xl">60</span> <span>seg</span>
      </div>
      <div class="flex gap-4 items-center">
        <button id="btnIniciarTempo"
          class="rounded-full w-16 h-16 bg-green-500 hover:bg-green-600 text-white flex items-center justify-center shadow relative"
          title="Iniciar Tempo">
          <svg id="clockIcon" viewBox="0 0 64 64" width="32" height="32" class="" xmlns="http://www.w3.org/2000/svg">
            <circle cx="32" cy="32" r="28" fill="#fff" stroke="#333" stroke-width="4"/>
            <circle cx="32" cy="32" r="3" fill="#333"/>
            <line x1="32" y1="4" x2="32" y2="10" stroke="#333" stroke-width="3"/>
            <line x1="32" y1="54" x2="32" y2="60" stroke="#333" stroke-width="3"/>
            <line x1="4" y1="32" x2="10" y2="32" stroke="#333" stroke-width="3"/>
            <line x1="54" y1="32" x2="60" y2="32" stroke="#333" stroke-width="3"/>
            <line id="clockHand" x1="32" y1="32" x2="32" y2="12" stroke="#000" stroke-width="3" stroke-linecap="round"/>
          </svg>
        </button>
        <button id="btnPular" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded font-semibold shadow flex items-center gap-1">
          <img src="https://cdn-icons-png.flaticon.com/512/54/54599.png" width="24" height="24" alt="passar"/>
          <span>Pular</span>
        </button>
      </div>
    </div>

    <div class="mb-4 p-4 bg-gradient-to-br from-blue-50 to-white rounded-2xl shadow-2xl">
      <div class="mb-4">
        <label class="block font-bold mb-2">Dica para o Adivinhador:</label>
        <div class="flex gap-2">
          <input type="text" id="campoDica" class="border border-gray-300 p-2 rounded w-full bg-white" />
          <button id="btnEnviarDica" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-semibold shadow">OK</button>
        </div>
      </div>
      <div>
        <label class="block font-bold mb-2">Chute do Adivinhador:</label>
        <div class="flex gap-2">
          <input type="text" id="campoChute" class="border border-gray-300 p-2 rounded w-full bg-white" />
          <button id="btnEnviarChute" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-semibold shadow">OK</button>
        </div>
      </div>
    </div>

    <div class="bg-gradient-to-br from-blue-50 to-white p-4 rounded-2xl shadow-2xl w-full">
      <h3 class="text-xl font-semibold mb-2">Histórico</h3>
      <div id="historicoAcoes" class="h-60 overflow-y-auto text-sm border border-gray-300 p-2 rounded bg-white">
        <!-- Ações -->
      </div>
    </div>
  </div>

  <!-- TELA FINAL -->
  <div id="end-screen" class="w-full max-w-4xl p-6 shadow-2xl bg-gradient-to-r from-white to-gray-50 rounded-2xl text-center mt-8 hidden relative">
    <h1 class="text-2xl font-bold mb-4">Partida Encerrada</h1>
    <p id="resultado" class="text-xl mb-2"></p>
    <div id="pontuacaoFinal" class="mb-4"></div>
    <button id="btnReiniciar" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-semibold shadow-lg">Reiniciar</button>
  </div>
</div>

<script>
  /* Confetti logic */
  const confettiCanvas = document.getElementById('confettiCanvas');
  const confettiCtx = confettiCanvas.getContext('2d');
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;

  window.addEventListener('resize', () => {
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  });

  function launchConfetti() {
    const end = Date.now() + 2 * 1000;
    (function frame() {
      confetti({
        particleCount: 5,
        angle: Math.random() * 60 + 100,
        spread: 55,
        origin: { x: Math.random(), y: Math.random() * 0.3 },
        useWorker: true,
      });
      if (Date.now() < end) {
        requestAnimationFrame(frame);
      }
    })();
  }

  // Provide shuffle.
  function shuffleArray(array){
    for(let i=array.length-1; i>0; i--){
      const j=Math.floor(Math.random()*(i+1));
      [array[i],array[j]]=[array[j],array[i]];
    }
    return array;
  }

  const btnRegras=document.getElementById('btnRegras');
  const btnFecharModal=document.getElementById('btnFecharModal');
  const btnFalarRegras=document.getElementById('btnFalarRegras');
  const modalRegras=document.getElementById('modalRegras');

  const configScreen=document.getElementById('config-screen');
  const mainScreen=document.getElementById('main-screen');
  const endScreen=document.getElementById('end-screen');

  const inputTempoMaximo=document.getElementById('tempoMaximo');
  const inputNomeJogador=document.getElementById('nomeJogador');
  const inputFotoJogador=document.getElementById('fotoJogador');
  const listaJogadoresEl=document.getElementById('listaJogadores');
  const modoDuplasSelect=document.getElementById('modoDuplas');

  const btnAdicionarJogador=document.getElementById('btnAdicionarJogador');
  const btnIniciar=document.getElementById('btnIniciar');
  const btnEncerrar=document.getElementById('btnEncerrar');
  const btnIniciarTempo=document.getElementById('btnIniciarTempo');
  const btnEnviarDica=document.getElementById('btnEnviarDica');
  const btnEnviarChute=document.getElementById('btnEnviarChute');
  const btnPular=document.getElementById('btnPular');
  const btnReiniciar=document.getElementById('btnReiniciar');
  const btnAbrirCamera=document.getElementById('btnAbrirCamera');
  const btnCapturarFoto=document.getElementById('btnCapturarFoto');

  const scoreContainer=document.getElementById('scoreContainer');
  const doadorEl=document.getElementById('doador');
  const doadorFoto=document.getElementById('doadorFoto');
  const adivinhadorEl=document.getElementById('adivinhador');
  const adivinhadorFoto=document.getElementById('adivinhadorFoto');
  const palavraSecretaEl=document.getElementById('palavraSecreta');
  const conteudoPalavraEl=document.getElementById('conteudoPalavra');
  const tempoRestanteEl=document.getElementById('tempoRestante');
  const campoDica=document.getElementById('campoDica');
  const campoChute=document.getElementById('campoChute');
  const historicoAcoes=document.getElementById('historicoAcoes');
  const endResultado=document.getElementById('resultado');
  const endPontuacaoFinal=document.getElementById('pontuacaoFinal');
  const togglePalavraCheckbox=document.getElementById('togglePalavra');
  const eyeIcon=document.getElementById('eyeIcon');

  const clockHand=document.getElementById('clockHand');

  const doadorLed=document.getElementById('doadorLed');
  const adivLed=document.getElementById('adivLed');

  // camera
  let cameraStream=null;
  let tempFotoDataUrl='';

  let tempoMaximoValue=60;
  let tempoRestante=60;
  let timerInterval=null;

  let jogadores=[];
  /* Only one global duplas. We'll remove any second let inside functions. */
  let duplas=[];
  let scores=[];
  let palavrasRodada=[];
  let indicePalavra=0;
  let duplaAtual=0;
  let primeiraTentativa=true;
  let mostraPalavra=false;
  let historico=[];

  let palavrasBanco={
    'PT-BR': ['cachorro','arco-iris','vermelho','futebol','jantar'],
    'PT-PT': ['cão','arc-íris','vermelho','futebol','jantar'],
    'EN-US': ['dog','rainbow','red','soccer','dinner'],
    'ES': ['perro','arcoiris','rojo','futbol','cena']
  };

  btnAbrirCamera.addEventListener('click', async ()=>{
    try{
      cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
      videoCamera.srcObject=cameraStream;
      videoCamera.classList.remove('hidden');
      btnCapturarFoto.classList.remove('hidden');
      canvasFoto.classList.add('hidden');
    }catch(err){
      alert('Não foi possível acessar a câmera: '+err);
    }
  });

  btnCapturarFoto.addEventListener('click', ()=>{
    if(!cameraStream)return;
    canvasFoto.classList.remove('hidden');
    canvasFoto.width=videoCamera.videoWidth;
    canvasFoto.height=videoCamera.videoHeight;
    const ctx=canvasFoto.getContext('2d');
    ctx.drawImage(videoCamera,0,0,canvasFoto.width,canvasFoto.height);

    let dataUrl=canvasFoto.toDataURL('image/png');

    videoCamera.classList.add('hidden');
    btnCapturarFoto.classList.add('hidden');
    if(cameraStream){
      cameraStream.getTracks().forEach(track=>track.stop());
      cameraStream=null;
    }

    tempFotoDataUrl=dataUrl;
  });

  function getSelectedIdioma(){
    const checked=document.querySelector('input[name=idiomaRadio]:checked');
    return checked?checked.value:'PT-BR';
  }

  function exibirTelaConfig(){
    configScreen.classList.remove('hidden');
    configScreen.classList.remove('fade-out');
    configScreen.classList.add('fade-in');

    mainScreen.classList.add('hidden');
    endScreen.classList.add('hidden');
  }

  function exibirTelaPrincipal(){
    configScreen.classList.remove('fade-in');
    configScreen.classList.add('fade-out');
    setTimeout(()=>{
      configScreen.classList.add('hidden');
      mainScreen.classList.remove('hidden');
      mainScreen.classList.add('fade-in');
      endScreen.classList.add('hidden');
    },1000);
  }

  function exibirTelaFinal(){
    mainScreen.classList.add('hidden');
    mainScreen.classList.remove('fade-in');
    endScreen.classList.remove('hidden');
  }

  btnAdicionarJogador.addEventListener('click', adicionarJogador);

  function adicionarJogador(){
    let nomeDigitado=inputNomeJogador.value.trim() || `Convidado #${jogadores.length+1}`;
    let colorClass=colorPalette[jogadores.length%colorPalette.length];

    let fotoDataUrl='';
    const file=fotoJogador.files[0];
    if(tempFotoDataUrl){
      fotoDataUrl=tempFotoDataUrl;
      tempFotoDataUrl='';
    }else if(file){
      const reader=new FileReader();
      reader.onload=(e)=>{
        fotoDataUrl=e.target.result;
        pushJogador(nomeDigitado,colorClass,fotoDataUrl);
      };
      reader.readAsDataURL(file);
      return;
    }

    pushJogador(nomeDigitado,colorClass,fotoDataUrl);
  }

  function pushJogador(name,colorClass,fotoDataUrl){
    const newPlayer={
      name,
      color:colorClass,
      photo:fotoDataUrl,
    };
    jogadores.push(newPlayer);
    inputNomeJogador.value='';
    fotoJogador.value='';
    renderJogadores();
  }

  function removerJogador(idx){
    jogadores.splice(idx,1);
    renderJogadores();
  }

  function renderJogadores(){
    listaJogadoresEl.innerHTML='';
    jogadores.forEach((player,idx)=>{
      const div=document.createElement('div');
      div.className=`${player.color} p-2 uppercase rounded mb-1 shadow-sm font-bold flex items-center gap-2 justify-between`;
      const leftPart=document.createElement('div');
      leftPart.className='flex items-center gap-2';
      if(player.photo){
        const imgEl=document.createElement('img');
        imgEl.src=player.photo;
        imgEl.alt='Foto';
        imgEl.className='w-8 h-8 object-cover rounded-full';
        leftPart.appendChild(imgEl);
      }
      const spanNome=document.createElement('span');
      spanNome.textContent=player.name;
      leftPart.appendChild(spanNome);
      div.appendChild(leftPart);

      const btnExcluir=document.createElement('button');
      btnExcluir.className='bg-red-400 hover:bg-red-500 text-white px-2 py-1 rounded font-bold';
      btnExcluir.textContent='Excluir';
      btnExcluir.addEventListener('click',()=>{
        removerJogador(idx);
      });
      div.appendChild(btnExcluir);
      listaJogadoresEl.appendChild(div);
    });
  }

  btnIniciar.addEventListener('click', iniciarJogo);

  // Only one global let duplas => no second let here.

  function iniciarJogo(){
    if(jogadores.length<4 || (jogadores.length%2!==0)){
      alert('É necessário ao menos 4 jogadores (número par).');
      return;
    }
    // reassign duplas
    duplas=[];
    const modo=modoDuplasSelect.value;
    let arrCopia=[...jogadores];
    if(modo!=='manual'){
      shuffleArray(arrCopia);
    }
    for(let i=0;i<arrCopia.length;i+=2){
      duplas.push([arrCopia[i],arrCopia[i+1]]);
    }
    scores=new Array(duplas.length).fill(0);

    const idioma=getSelectedIdioma();
    let listaPalavrasBrutas=Array.from(new Set(palavrasBanco[idioma]||[]));
    shuffleArray(listaPalavrasBrutas);
    palavrasRodada=listaPalavrasBrutas.slice(0,5);

    indicePalavra=0;
    duplaAtual=0;
    primeiraTentativa=true;

    tempoMaximoValue=parseInt(inputTempoMaximo.value)||60;
    tempoRestante=tempoMaximoValue;
    tempoRestanteEl.textContent=tempoRestante;
    tempoRestanteEl.classList.remove('text-red-600');
    tempoRestanteEl.classList.add('text-green-600');

    mostraPalavra=false;
    togglePalavraCheckbox.checked=false;
    palavraSecretaEl.classList.add('hidden');
    eyeIcon.innerHTML=`<svg viewBox='0 0 64 64'><path d='M2 32c6-14 18-22 30-22s24 8 30 22c-6 14-18 22-30 22S8 46 2 32z' fill='#ccc'/><path d='M10 10 L54 54' stroke='#444' stroke-width='5'/></svg>`;

    historico=[];
    atualizarHistoricoNaTela();
    renderPontuacao();
    atualizarDuplaNaTela();
    exibirTelaPrincipal();
  }

  const endResultado=document.getElementById('resultado');
  const endPontuacaoFinal=document.getElementById('pontuacaoFinal');

  btnEncerrar.addEventListener('click', encerrarPartida);
  function encerrarPartida(){
    exibirTelaFinal();
    pararTimer();
    let maiorPontuacao=Math.max(...scores);
    let indicesMax=scores.map((val,idx)=> val===maiorPontuacao ? idx : -1).filter(i=>i>=0);
    if(indicesMax.length>1){
      endResultado.textContent='Temos um Empate!';
    } else{
      const campeaoArr=duplas[indicesMax[0]];
      const campeao=campeaoArr[0].name+' & '+campeaoArr[1].name;
      endResultado.textContent='Dupla Vencedora: '+campeao;
    }
    endPontuacaoFinal.innerHTML='<h2 class="font-semibold">Pontuação Final</h2>';
    duplas.forEach((dupla,idx)=>{
      let nomes=dupla[0].name.toUpperCase()+' & '+dupla[1].name.toUpperCase();
      const div=document.createElement('div');
      div.className='flex items-center gap-2 my-2';
      dupla.forEach((p)=>{
        if(p.photo){
          const img=document.createElement('img');
          img.src=p.photo;
          img.alt='Foto';
          img.className='w-8 h-8 object-cover rounded-full';
          div.appendChild(img);
        }
      });
      const txt=document.createElement('span');
      txt.textContent=nomes+': '+scores[idx]+' pts';
      div.appendChild(txt);
      endPontuacaoFinal.appendChild(div);
    });
    indicesMax.forEach(()=>{
      launchConfetti();
    });
  }

  btnReiniciar.addEventListener('click', reiniciar);
  function reiniciar(){
    jogadores=[];
    duplas=[];
    scores=[];
    palavrasRodada=[];
    indicePalavra=0;
    duplaAtual=0;
    mostraPalavra=false;
    tempoRestante=60;
    historico=[];
    inputNomeJogador.value='';
    fotoJogador.value='';
    renderJogadores();
    exibirTelaConfig();
  }

  let historico=[];
  function atualizarHistoricoNaTela(){
    historicoAcoes.innerHTML='';
    historico.forEach((h)=>{
      let mensagem='';
      let icone='';
      if(h.acao==='DICA'){
        icone='💡';
        mensagem=`${icone} ${h.jogador}: "${h.texto}"`;
      }else if(h.acao==='ERRO'){
        icone='❌';
        mensagem=`${icone} ${h.jogador}: "${h.texto}"`;
      }else if(h.acao==='ACERTO'){
        icone='✅';
        mensagem=`${icone} ${h.jogador} +${h.points||0} pts`;
      }else if(h.acao==='PULOU'){
        icone='⏭️';
        mensagem=`${icone} ${h.jogador}: ${h.texto}`;
      }

      const secretIcon=document.createElement('span');
      secretIcon.textContent='🔎';
      secretIcon.className='ml-2 text-blue-700 hover-scale';
      secretIcon.title='Ver palavra secreta';
      secretIcon.addEventListener('click',()=>{
        alert(`A palavra secreta era: ${h.palavra}`);
      });

      const div=document.createElement('div');
      div.textContent=mensagem;
      div.appendChild(secretIcon);
      historicoAcoes.appendChild(div);
    });
    historicoAcoes.scrollTop=historicoAcoes.scrollHeight;
  }

  function registrarHistorico(acao,texto,jogador,pontos){
    const currentWord=palavrasRodada[indicePalavra]||'';
    historico.push({acao,texto,jogador,points:pontos, palavra:currentWord});
    atualizarHistoricoNaTela();
  }

  function renderPontuacao(){
    scoreContainer.innerHTML='';
    duplas.forEach((dupla,idx)=>{
      let nomes=dupla[0].name.toUpperCase()+' & '+dupla[1].name.toUpperCase();
      const row=document.createElement('div');
      row.className='p-2 bg-white rounded shadow flex items-center gap-2';

      dupla.forEach((p)=>{
        if(p.photo){
          const img=document.createElement('img');
          img.src=p.photo;
          img.alt='Foto';
          img.className='w-6 h-6 object-cover rounded-full';
          row.appendChild(img);
        }
      });
      const txt=document.createElement('span');
      txt.className='font-bold text-sm';
      txt.textContent=nomes;
      row.appendChild(txt);
      const pts=document.createElement('span');
      pts.className='text-blue-700 font-extrabold text-lg ml-auto';
      pts.textContent=`${scores[idx]} pts`;
      row.appendChild(pts);
      scoreContainer.appendChild(row);
    });
  }

  function getDoadorName(){
    return duplas[duplaAtual][0].name.toUpperCase();
  }
  function getAdivinhadorName(){
    return duplas[duplaAtual][1].name.toUpperCase();
  }

  function atualizarDuplaNaTela(){
    const doadorPlayer=duplas[duplaAtual][0];
    const adivPlayer=duplas[duplaAtual][1];
    doadorLed.textContent=`${doadorPlayer.name}, é sua vez de dar a DICA!`;
    adivLed.textContent=`${adivPlayer.name}, é sua vez de ADIVINHAR!`;

    doadorEl.textContent=doadorPlayer.name.toUpperCase();
    adivinhadorEl.textContent=adivPlayer.name.toUpperCase();
    conteudoPalavraEl.textContent=palavrasRodada[indicePalavra]||'';

    if(doadorPlayer.photo){
      doadorFoto.src=doadorPlayer.photo;
      doadorFoto.classList.remove('hidden');
    } else{
      doadorFoto.classList.add('hidden');
    }
    if(adivPlayer.photo){
      adivinhadorFoto.src=adivPlayer.photo;
      adivinhadorFoto.classList.remove('hidden');
    } else{
      adivinhadorFoto.classList.add('hidden');
    }
  }

  function pararTimer(){
    if(timerInterval){
      clearInterval(timerInterval);
      timerInterval=null;
    }
    clockHand.classList.remove('spin');
  }

  function iniciarTimer(){
    pararTimer();
    clockHand.classList.add('spin');
    timerInterval=setInterval(()=>{
      tempoRestante--;
      tempoRestanteEl.textContent=tempoRestante;
      if(tempoRestante<=10){
        tempoRestanteEl.classList.remove('text-green-600');
        tempoRestanteEl.classList.add('text-red-600');
      } else{
        tempoRestanteEl.classList.remove('text-red-600');
        tempoRestanteEl.classList.add('text-green-600');
      }
      if(tempoRestante<=0){
        pararTimer();
        registrarHistorico('PULOU','Tempo esgotado.', getAdivinhadorName());
        passarParaProximaDuplaMesmaPalavra();
      }
    },1000);
  }

  function pularPalavra(){
    registrarHistorico('PULOU','Palavra pulada',getAdivinhadorName());
    pararTimer();
    passarParaProximaPalavra();
  }

  function passarParaProximaPalavra(){
    indicePalavra++;
    if(indicePalavra>=palavrasRodada.length){
      encerrarPartida();
      return;
    }
    duplaAtual=(duplaAtual+1)%duplas.length;
    tempoRestante=tempoMaximoValue;
    tempoRestanteEl.textContent=tempoRestante;
    primeiraTentativa=true;
    tempoRestanteEl.classList.remove('text-red-600');
    tempoRestanteEl.classList.add('text-green-600');
    mostraPalavra=false;
    togglePalavraCheckbox.checked=false;
    palavraSecretaEl.classList.add('hidden');
    eyeIcon.innerHTML=`<svg viewBox='0 0 64 64'><path d='M2 32c6-14 18-22 30-22s24 8 30 22c-6 14-18 22-30 22S8 46 2 32z' fill='#ccc'/><path d='M10 10 L54 54' stroke='#444' stroke-width='5'/></svg>`;
    atualizarDuplaNaTela();
  }

  function passarParaProximaDuplaMesmaPalavra(){
    pararTimer();
    duplaAtual=(duplaAtual+1)%duplas.length;
    tempoRestante=tempoMaximoValue;
    tempoRestanteEl.textContent=tempoRestante;
    tempoRestanteEl.classList.remove('text-red-600');
    tempoRestanteEl.classList.add('text-green-600');
    mostraPalavra=false;
    togglePalavraCheckbox.checked=false;
    palavraSecretaEl.classList.add('hidden');
    eyeIcon.innerHTML=`<svg viewBox='0 0 64 64'><path d='M2 32c6-14 18-22 30-22s24 8 30 22c-6 14-18 22-30 22S8 46 2 32z' fill='#ccc'/><path d='M10 10 L54 54' stroke='#444' stroke-width='5'/></svg>`;
    atualizarDuplaNaTela();
  }

  function enviarDica(){
    const dica=campoDica.value.trim();
    if(!dica)return;
    registrarHistorico('DICA', dica, getDoadorName());
    campoDica.value='';
  }

  function enviarChute(){
    const chute=campoChute.value.trim();
    if(!chute)return;
    const palavraAtual=palavrasRodada[indicePalavra];
    if(!palavraAtual)return;

    if(chute.toLowerCase()===palavraAtual.toLowerCase()){
      const adiv=getAdivinhadorName();
      const pontos=primeiraTentativa?2:1;
      registrarHistorico('ACERTO', chute, adiv, pontos);
      scores[duplaAtual]+=pontos;
      renderPontuacao();
      passarParaProximaPalavra();
    } else{
      registrarHistorico('ERRO', chute, getAdivinhadorName());
      if(primeiraTentativa){
        primeiraTentativa=false;
      }
      passarParaProximaDuplaMesmaPalavra();
    }
    campoChute.value='';
  }

  // Regras
  btnRegras.addEventListener('click',()=>{
    modalRegras.classList.remove('hidden');
    modalRegras.classList.add('flex');
  });
  btnFecharModal.addEventListener('click',()=>{
    modalRegras.classList.add('hidden');
    modalRegras.classList.remove('flex');
  });
  btnFalarRegras.addEventListener('click',()=>{
    const msg=new SpeechSynthesisUtterance();
    msg.text=`
      1) Forme duplas de jogadores, com no mínimo 4 pessoas (número par).
      2) A cada palavra, a dupla da vez inicia tentando acertar: se acertar de primeira, ganha 2 pontos.
      3) Se errar, as outras duplas (ou ela mesma, em nova vez) só ganham 1 ponto se acertarem.
      4) Se pular ou o tempo acabar, passa para a próxima dupla, podendo manter a mesma palavra ou avançar, dependendo do caso.
      5) Ao final do banco de palavras, a dupla com maior pontuação vence.
    `;
    msg.lang='pt-BR';
    speechSynthesis.speak(msg);
  });

  // Toggle exibir palavra secreta
  togglePalavraCheckbox.addEventListener('change',(evt)=>{
    if(evt.target.checked){
      palavraSecretaEl.classList.remove('hidden');
      eyeIcon.innerHTML=`<svg viewBox='0 0 64 64'><path d='M2 32c6-14 18-22 30-22s24 8 30 22c-6 14-18 22-30 22S8 46 2 32z' fill='#ccc'/><!-- open eye --> <circle cx='32' cy='32' r='8' fill='#444'/> </svg>`;
      mostraPalavra=true;
    } else{
      palavraSecretaEl.classList.add('hidden');
      eyeIcon.innerHTML=`<svg viewBox='0 0 64 64'><path d='M2 32c6-14 18-22 30-22s24 8 30 22c-6 14-18 22-30 22S8 46 2 32z' fill='#ccc'/><path d='M10 10 L54 54' stroke='#444' stroke-width='5'/></svg>`;
      mostraPalavra=false;
    }
  });

  btnIniciarTempo.addEventListener('click', iniciarTimer);
  btnEnviarDica.addEventListener('click', enviarDica);
  btnEnviarChute.addEventListener('click', enviarChute);
  btnPular.addEventListener('click', pularPalavra);

  // Start
  exibirTelaConfig();
</script>
</body>
</html>
